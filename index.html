<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>DQé¢¨ãƒ»RPGåœŸå° v2.0ï¼ˆæ’ƒç ´ç¢ºå®šï¼‹5ä½“è¿½åŠ ï¼‹2å€ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆï¼imageså‚ç…§ï¼‰</title>
<style>
  :root{
    --panel:#101823; --panel2:#0f1420; --text:#e7f0ff; --muted:#98a3b3; --ok:#2ee59d; --acc:#79e3ff; --acc2:#9bf570; --danger:#ff6b6b;
    --grid:48;
  }
  *{box-sizing:border-box}
  body{ margin:0; background:linear-gradient(180deg,#0a0f1a,#06080f); color:var(--text);
        font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
        display:flex; min-height:100svh; align-items:center; justify-content:center; }
  .wrap{ width:min(100vw,900px); padding:12px; display:grid; gap:12px; grid-template-rows:auto 1fr auto; }
  header{ display:flex; gap:8px; align-items:center; justify-content:space-between;
          background:linear-gradient(180deg,rgba(255,255,255,.06),transparent);
          padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.06); box-shadow:inset 0 0 0 1px rgba(255,255,255,.03); }
  header .title{font-weight:700; letter-spacing:.02em}
  .btns{display:flex; gap:8px; flex-wrap:wrap}
  button{ appearance:none; border:none; color:var(--text); background:var(--panel);
          padding:10px 14px; border-radius:10px; font-weight:600; letter-spacing:.02em; border:1px solid rgba(255,255,255,.08); }
  button:hover{filter:brightness(1.1)} button:active{transform:translateY(1px)} button[disabled]{opacity:.5; pointer-events:none}

  .screen{ position:relative; border-radius:16px; overflow:hidden;
           background:radial-gradient(80% 100% at 50% 0%, #0c1625, #050812 80%);
           border:1px solid rgba(255,255,255,.08); aspect-ratio:16/9; min-height:360px; }

  /* === ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ / HUD === */
  .field{ position:absolute; inset:0; display:grid; grid-template-rows:auto 1fr; }
  .hud{ display:flex; gap:12px; padding:8px 12px; background:rgba(0,0,0,.25); border-bottom:1px solid rgba(255,255,255,.08); backdrop-filter: blur(6px); }
  .badge{ padding:6px 10px; border-radius:8px; background:var(--panel); border:1px solid rgba(255,255,255,.06); font-size:12px; color:var(--muted) }
  .hintMove{color:var(--muted); margin-left:auto; font-size:12px}
  .viewport{ position:relative; margin:12px; border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,.08);
             background:#0b1422; width:calc(var(--grid)*9px); height:calc(var(--grid)*9px); }
  .world{ position:absolute; left:0; top:0; will-change:transform; }
  .tile{ position:absolute; width:calc(var(--grid)*1px); height:calc(var(--grid)*1px); outline:1px solid rgba(255,255,255,.03); display:grid; place-items:center; font-size:18px; }
  .t-grass{ background:linear-gradient(180deg,#0c1f2c,#0d2a2a) } .t-forest{ background:linear-gradient(180deg,#0f1f18,#0c2617) } .t-road{ background:linear-gradient(180deg,#1a1a24,#15151d) }
  .player,.prop{ position:absolute; width:calc(var(--grid)*1px); height:calc(var(--grid)*1px);
                 display:grid; place-items:center; font-size:22px; filter:drop-shadow(0 6px 8px rgba(0,0,0,.4)); transition:transform .12s ease-out; }
  .prop{ font-size:20px }

  /* === ä¼šè©± === */
  .dialog{ position:absolute; left:8px; right:8px; bottom:8px; padding:12px; background:rgba(10,15,25,.9);
           border:1px solid rgba(255,255,255,.12); border-radius:12px; display:none; z-index:5; }
  .dialog.active{ display:block; }
  .dialog .name{ font-weight:700; color:var(--acc2); margin-bottom:6px; }
  .dialog .text{ min-height:44px }
  .choices{ display:none; margin-top:10px; gap:8px; }
  .choices.active{ display:flex; flex-wrap:wrap; }
  .choice{ flex:1 1 120px; padding:10px 12px; border-radius:10px; background:linear-gradient(180deg,#1c2a44,#101b2f); border:1px solid rgba(255,255,255,.12); text-align:center; }
  .choice:focus{ outline:2px solid var(--acc); }

  /* === æˆ¦é—˜ === */
  .battle{ position:absolute; inset:0; display:none; grid-template-rows:1fr auto; padding:12px; }
  .battle.active{ display:grid }
  .battleStage{ border-radius:12px; border:1px solid rgba(255,255,255,.08);
                background: radial-gradient(60% 60% at 50% 20%, #172238, transparent 60%), linear-gradient(180deg,#0b0f1a,#050812);
                position:relative; overflow:hidden; }
  .battleUI{ margin-top:12px; display:grid; gap:10px; grid-template-columns:1fr; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:linear-gradient(180deg, var(--panel), var(--panel2)); }
  .row{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
  .hpbar{ --v:1; inline-size:180px; block-size:12px; border-radius:999px; background:#1d2a3d; overflow:hidden; border:1px solid rgba(255,255,255,.08); }
  .hpbar>i{ display:block; width:calc(var(--v) * 100%); height:100%; background:linear-gradient(90deg,var(--ok),#ffee58)}
  .hpnum{font-variant-numeric:tabular-nums; min-width:160px; text-align:right; white-space:nowrap }

  /* æ•µã‚¹ãƒ—ãƒ©ã‚¤ãƒˆï¼ˆæœ€å‰é¢ï¼†ãã£ãã‚Šï¼‰ */
  #enemyBattle{
    position:absolute; right:24px; top:32px;
    display:grid; place-items:center;
    width:200px; height:200px;
    z-index:2;
  }
  #enemyBattle .emoji{
    font-size:88px; transform:scale(1.25);
    filter: drop-shadow(0 10px 18px rgba(0,0,0,.5));
  }
  .enemySprite{
    width:200px; height:200px;
    object-fit:contain; object-position:center;
    image-rendering:auto;
    filter: drop-shadow(0 10px 18px rgba(0,0,0,.5));
    mix-blend-mode:normal !important; /* â† èƒŒæ™¯ã£ã½ããªã‚‰ãªã„ */
    opacity:1; z-index:2; pointer-events:none;
  }

  /* å‹‡è€…2å€ï¼ˆãƒãƒˆãƒ«ï¼‰ */
  #playerBattle{ font-size:44px; filter: drop-shadow(0 10px 18px rgba(0,0,0,.5)); }

  /* ï¼ˆä»»æ„ï¼‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸Šã®å‹‡è€…ã‚‚2å€ã«ã—ãŸã„ãªã‚‰æœ‰åŠ¹åŒ–
  #player{ font-size:44px; }
  */
  
  /* === ã‚·ãƒ¼ãƒˆï¼ˆãƒãƒƒã‚°ï¼ã‚»ãƒ¼ãƒ–ï¼ãƒ­ã‚°ï¼‰ === */
  .sheetWrap{ position:absolute; left:0; right:0; bottom:0; pointer-events:none; z-index:6; }
  .sheet{ margin:0 auto; max-width:860px; translate:0 100%; pointer-events:auto; transition:translate .25s ease-out;
          background:linear-gradient(180deg,#121b2b,#0b1320); border-top-left-radius:16px; border-top-right-radius:16px;
          border:1px solid rgba(255,255,255,.10); border-bottom:none; box-shadow:0 -16px 40px rgba(0,0,0,.5); }
  .sheet.active{ translate:0 0 }
  .sheetHead{ display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid rgba(255,255,255,.08) }
  .sheetBody{ padding:10px; display:grid; gap:10px; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); }
  .itemCard,.slotCard,.logCard,.taskCard{ background:linear-gradient(180deg,#162235,#0f1828); border:1px solid rgba(255,255,255,.10); border-radius:12px; padding:12px; display:grid; gap:8px; }
  .itemHead,.slotHead,.logHead,.taskHead{ display:flex; gap:8px; align-items:center; justify-content:space-between }
  .itemName{ font-weight:700 }
  .qty{ color:var(--muted); font-variant-numeric:tabular-nums }
  .desc{ color:var(--muted); font-size:13px; min-height:2.2em }
  .toast{ position:absolute; left:50%; bottom:calc(100% + 8px); translate:-50% 10px; opacity:0; background:#0b1320; border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:8px 12px; transition:.25s ease; font-size:14px }
  .toast.show{ translate:-50% 0; opacity:1 }

  /* ã‚»ãƒ¼ãƒ– */
  .saveWrap{ z-index:7 }
  .modeTabs{ display:flex; gap:6px; } .tabBtn{ padding:8px 12px; border-radius:10px; background:linear-gradient(180deg,#1c2a44,#101b2f); border:1px solid rgba(255,255,255,.12); }
  .tabBtn.active{ outline:2px solid var(--acc) }
  .meta{ color:var(--muted); font-size:12px }
  .slotBody{ color:var(--muted); font-size:13px; line-height:1.5 }

  /* ãƒ­ã‚° */
  .journalWrap{ z-index:8 }
  .jTabs{ display:flex; gap:6px; }
  .chip{ font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--muted) }
  .done{ color:var(--acc2) }
  .muted{ color:var(--muted) }
  .logBody{ color:var(--muted); font-size:13px; line-height:1.5 }
  .taskBody{ color:var(--muted); font-size:13px; line-height:1.5 }
  .taskCard.done{ opacity:.85; box-shadow:inset 0 0 0 1px rgba(155,245,112,.25); }

  /* ãƒ¢ãƒã‚¤ãƒ«æ“ä½œ */
  .controls{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:4px; }
  .dpad{ display:grid; grid-template-areas: ". up ." "left center right" ". down ."; gap:6px; justify-items:center; align-items:center; }
  .dpad button{ width:56px; height:56px; border-radius:14px; background:linear-gradient(180deg,#132235,#0c1522) }
  .dpad .up{grid-area:up} .dpad .down{grid-area:down} .dpad .left{grid-area:left} .dpad .right{grid-area:right}
  .act{ display:grid; align-content:center; justify-items:stretch; gap:8px; }
  .act button{ height:56px; border-radius:14px; background:linear-gradient(180deg,#1c2a44,#101b2f) }
  .footnote{ color:var(--muted); font-size:12px; text-align:center }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">DQé¢¨ãƒ»RPGåœŸå° v2.0ï¼ˆæ’ƒç ´ç¢ºå®šï¼‹5ä½“è¿½åŠ ï¼‹2å€ï¼‰</div>
    <div class="btns">
      <button id="btnBag">ãƒãƒƒã‚° (I)</button>
      <button id="btnJournal">ãƒ­ã‚° (Q)</button>
      <button id="btnSave">ã‚»ãƒ¼ãƒ– (S)</button>
      <button id="btnLoad">ãƒ­ãƒ¼ãƒ‰ (L)</button>
      <button id="btnHeal">å›å¾©(+20HP)</button>
      <button id="btnReset">åˆæœŸåŒ–</button>
    </div>
  </header>

  <main class="screen">
    <!-- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
    <section class="field" id="field">
      <div class="hud">
        <span class="badge">çŠ¶æ…‹: <b id="stateLabel">field</b></span>
        <span class="badge">åº§æ¨™: <b id="posLabel">0,0</b></span>
        <span class="badge">åœ°å½¢: <b id="terrainLabel">-</b></span>
        <span class="badge">é­é‡ç‡: <b id="encLabel">-</b></span>
        <span class="badge">æ‰€æŒ: <b id="invLabel">Potion x0 | Key x0</b></span>
        <span class="hintMove">ç§»å‹•ã‚³ã‚¹ãƒˆï¼šé“&lt;è‰åŸ&lt;æ£®</span>
      </div>
      <div class="viewport" id="viewport"><div class="world" id="world"></div></div>

      <!-- ä¼šè©± -->
      <div class="dialog" id="dialog">
        <div class="name" id="dialogName">ğŸª§ çœ‹æ¿</div>
        <div class="text" id="dialogText"></div>
        <div class="choices" id="choices"></div>
        <div class="hint">Enter / Actionã§æ±ºå®šãƒ»æ¬¡ã¸</div>
      </div>

      <!-- ãƒãƒƒã‚°ï¼ã‚»ãƒ¼ãƒ–ï¼ã‚¸ãƒ£ãƒ¼ãƒŠãƒ« -->
      <div class="sheetWrap"><div class="sheet" id="bagSheet" aria-hidden="true">
        <div class="sheetHead"><div style="font-weight:700">ğŸ’ ãƒãƒƒã‚°</div><div><button id="btnCloseBag">é–‰ã˜ã‚‹</button></div></div>
        <div class="sheetBody" id="bagList"></div><div class="toast" id="toast"></div></div></div>

      <div class="sheetWrap saveWrap"><div class="sheet" id="saveSheet" aria-hidden="true">
        <div class="sheetHead"><div style="display:flex; align-items:center; gap:10px;">
          <div style="font-weight:700">ğŸ’¾ è¨˜éŒ²</div>
          <div class="modeTabs"><button class="tabBtn" id="tabSave">ä¿å­˜</button><button class="tabBtn" id="tabLoad">èª­è¾¼</button></div>
        </div><div><button id="btnCloseSave">é–‰ã˜ã‚‹</button></div></div>
        <div class="sheetBody" id="slotList"></div><div class="toast" id="toastSave"></div></div></div>

      <div class="sheetWrap journalWrap"><div class="sheet" id="journalSheet" aria-hidden="true">
        <div class="sheetHead"><div style="display:flex; align-items:center; gap:10px;">
          <div style="font-weight:700">ğŸ“œ ãƒ­ã‚°</div>
          <div class="jTabs"><button class="tabBtn" id="tabJLog">å‡ºæ¥äº‹</button><button class="tabBtn" id="tabJTask">ã‚¯ã‚¨ã‚¹ãƒˆ</button></div>
        </div><div style="display:flex; gap:8px;"><button id="btnClearLog">ãƒ­ã‚°æ¶ˆå»</button><button id="btnCloseJournal">é–‰ã˜ã‚‹</button></div></div>
        <div class="sheetBody" id="journalList"></div><div class="toast" id="toastJournal"></div></div></div>
    </section>

    <!-- æˆ¦é—˜ -->
    <section class="battle" id="battle">
      <div class="battleStage">
        <div class="player" id="playerBattle" style="left:24px; top:56px">ğŸ§</div>
        <div id="enemyBattle"></div>
      </div>
      <div class="battleUI">
        <div class="row"><div>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼HP</div><div class="hpbar"><i id="pHpBar"></i></div><div class="hpnum" id="pHpNum"></div></div>
        <div class="row"><div>ã‚¨ãƒãƒŸãƒ¼HP</div><div class="hpbar"><i id="eHpBar"></i></div><div class="hpnum" id="eHpNum"></div></div>
        <div class="row"><div class="log" id="log">ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ãƒˆï¼</div></div>
        <div class="row">
          <button id="actAttack">ã“ã†ã’ã</button>
          <button id="actSkill">ã‚¹ã‚­ãƒ«ï¼šãƒ™ãƒãƒ </button>
          <button id="actItem">ã‚¢ã‚¤ãƒ†ãƒ (å›å¾©è–¬)</button>
          <button id="actRun">ã«ã’ã‚‹</button>
          <button id="actEnd" style="display:none;">ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¸</button>
        </div>
      </div>
    </section>
  </main>

  <section class="controls">
    <div class="dpad">
      <button class="up" data-dir="up">â–²</button>
      <button class="left" data-dir="left">â—€</button>
      <button class="right" data-dir="right">â–¶</button>
      <button class="down" data-dir="down">â–¼</button>
      <button class="center" disabled style="opacity:.3;">ï¼‹</button>
    </div>
    <div class="act">
      <button id="btnAction">Action / æ±ºå®š</button>
      <div class="footnote">PC: çŸ¢å°/Enter / I(ãƒãƒƒã‚°) / Q(ãƒ­ã‚°) / S(ä¿å­˜) / L(èª­è¾¼)</div>
    </div>
  </section>
</div>

<script>
/* ========= ç”»åƒã‚¢ã‚»ãƒƒãƒˆ =========
  é€æ˜PNGæ¨å¥¨ã€‚ãƒ•ã‚©ãƒ«ãƒ€ã¯ images/ ï¼ˆindex.html ã¨åŒéšå±¤ï¼‰ */
const IMG_ASSETS = {
  slime:   null, // ã‚¹ãƒ©ã‚¤ãƒ ã¯çµµæ–‡å­—
  tamakoroshi: 'images/tamakoroshi.png',
  kuginame:    'images/kuginame-sashikuji.png',
  hitomete:    'images/hitomete.png',
  hitokazuta:  'images/hitokazuta.png',
  toshiyori:   'images/toshiyori-obake.png'
};
/* ========= åŸºæœ¬å®šæ•°ï¼çŠ¶æ…‹ ========= */
const MAP_W=20, MAP_H=15, VIEW_W=9, VIEW_H=9;
const TILE=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--grid'));
const TERRAIN={GRASS:'GRASS',FOREST:'FOREST',ROAD:'ROAD'};
const TERRAIN_NAME={GRASS:'è‰åŸ',FOREST:'æ£®',ROAD:'é“'};
const ENCOUNTER={GRASS:0.05,FOREST:0.09,ROAD:0.01};
const MOVE_DELAY={GRASS:90,FOREST:230,ROAD:40};
const SAVE_PREFIX='miniRPG_s';

const worldEl=document.getElementById('world');
const stateLabel=document.getElementById('stateLabel');
const posLabel=document.getElementById('posLabel');
const terrLabel=document.getElementById('terrainLabel');
const encLabel=document.getElementById('encLabel');
const invLabel=document.getElementById('invLabel');

const dialogEl=document.getElementById('dialog');
const dialogText=document.getElementById('dialogText');
const choicesEl=document.getElementById('choices');

const bagSheet=document.getElementById('bagSheet');
const bagList=document.getElementById('bagList');
const toastEl=document.getElementById('toast');

const saveSheet=document.getElementById('saveSheet');
const slotList=document.getElementById('slotList');
const toastSave=document.getElementById('toastSave');
const tabSave=document.getElementById('tabSave');
const tabLoad=document.getElementById('tabLoad');

const journalSheet=document.getElementById('journalSheet');
const journalList=document.getElementById('journalList');
const toastJournal=document.getElementById('toastJournal');
const tabJLog=document.getElementById('tabJLog');
const tabJTask=document.getElementById('tabJTask');

const battleEl=document.getElementById('battle'), fieldEl=document.getElementById('field');
const logEl=document.getElementById('log'); const pHpBar=document.getElementById('pHpBar'), eHpBar=document.getElementById('eHpBar');
const pHpNum=document.getElementById('pHpNum'), eHpNum=document.getElementById('eHpNum');
const enemyStage=document.getElementById('enemyBattle');

const game={
  mode:'field',
  player:{ x:Math.floor(MAP_W/2), y:Math.floor(MAP_H/2), hp:60,hpMax:60,atk:12,def:3,
           items:{potion:2,key:0}, status:{weaken:{turns:0, atkDown:3}} },
  enemy:null,
  terrain:[], props:[],
  camera:{x:0,y:0},
  dialog:{active:false,lines:[],index:0,choices:[],onChoice:null,typing:false},
  flags:{signGiven:false,tutorialDone:false,gateOpen:false,chestOpened:false},
  moveLockUntil:0,
  bagOpen:false, saveOpen:false, journalOpen:false,
  saveMode:'save', journalMode:'log',
  journal:{ entries:[], tasks:[ {id:'openChest', title:'åŒ—è¥¿ã®å®ç®±ã‚’é–‹ã‘ã‚‹', done:false}, {id:'openGate', title:'ã‚²ãƒ¼ãƒˆã‚’é–‹ã‘ã‚‹', done:false} ] }
};

/* ========= ä¾¿åˆ©é–¢æ•° ========= */
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}
function toast(msg){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),1200); }
function toast2(msg){ toastSave.textContent=msg; toastSave.classList.add('show'); setTimeout(()=>toastSave.classList.remove('show'),1200); }
function toast3(msg){ toastJournal.textContent=msg; toastJournal.classList.add('show'); setTimeout(()=>toastJournal.classList.remove('show'),1200); }
function fmtTime(ts){ const d=new Date(ts); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function record(tag,text){ game.journal.entries.unshift({t:Date.now(),tag,text,x:game.player.x,y:game.player.y}); if(game.journal.entries.length>60) game.journal.entries.pop(); if(game.journalOpen && game.journalMode==='log') renderJournal(); }
function setTaskDone(id,done=true){ const t=game.journal.tasks.find(x=>x.id===id); if(t){ t.done=!!done; if(game.journalOpen && game.journalMode==='task') renderJournal(); }}

/* ========= ãƒãƒƒãƒ—ç”Ÿæˆ/ãƒ“ãƒ«ãƒ‰ ========= */
function genTerrain(){ game.terrain=Array.from({length:MAP_H},()=>Array.from({length:MAP_W},()=>TERRAIN.GRASS));
  for(let k=0;k<24;k++){ const cx=Math.floor(Math.random()*MAP_W), cy=Math.floor(Math.random()*MAP_H); const r=1+Math.floor(Math.random()*2);
    for(let y=-r;y<=r;y++)for(let x=-r;x<=r;x++){ const nx=cx+x, ny=cy+y; if(nx>=0&&ny>=0&&nx<MAP_W&&ny<MAP_H && Math.hypot(x,y)<=r+0.3) game.terrain[ny][nx]=TERRAIN.FOREST; } }
  const ry=Math.floor(MAP_H/2), rx=Math.floor(MAP_W/2); for(let x=0;x<MAP_W;x++) game.terrain[ry][x]=TERRAIN.ROAD; for(let y=0;y<MAP_H;y++) game.terrain[y][rx]=TERRAIN.ROAD;
}
function buildWorld(){
  worldEl.innerHTML=''; worldEl.style.width=(MAP_W*TILE)+'px'; worldEl.style.height=(MAP_H*TILE)+'px';
  for(let y=0;y<MAP_H;y++)for(let x=0;x<MAP_W;x++){ const t=document.createElement('div');
    t.className='tile '+(game.terrain[y][x]===TERRAIN.FOREST?'t-forest':game.terrain[y][x]===TERRAIN.ROAD?'t-road':'t-grass');
    t.style.left=(x*TILE)+'px'; t.style.top=(y*TILE)+'px'; const r=Math.random(); if(game.terrain[y][x]===TERRAIN.FOREST && r<0.18) t.textContent='ğŸŒ²'; else if(game.terrain[y][x]===TERRAIN.GRASS && r<0.07) t.textContent='ğŸŒ¿'; worldEl.appendChild(t); }
  const rx=Math.floor(MAP_W/2), ry=Math.floor(MAP_H/2);
  game.props=[]; addProp({x:rx+2,y:ry,type:'sign',name:'ğŸª§ çœ‹æ¿',icon:'ğŸª§'});
  const gatePos={x:rx+6,y:ry}; if(game.flags.gateOpen){ game.terrain[gatePos.y][gatePos.x]=TERRAIN.ROAD; } else { addProp({x:gatePos.x,y:ry,type:'gate',name:'ğŸš§ ã‚²ãƒ¼ãƒˆ',icon:'ğŸš§',open:false}); }
  const chestPos={x:rx-6,y:ry-2}; addProp({x:chestPos.x,y:chestPos.y,type:'chest',name:'ğŸ“¦ å®ç®±',icon:game.flags.chestOpened?'ğŸ§°':'ğŸ“¦',opened: game.flags.chestOpened});
  const p=document.createElement('div'); p.id='player'; p.className='player'; p.textContent='ğŸ§'; worldEl.appendChild(p);
  updatePlayerPos(); updateInvHUD(); updateTerrainHUD(); updateCamera();
}
function addProp(p){ const el=document.createElement('div'); el.className='prop'; el.textContent=p.icon||'â“'; el.style.transform=`translate(${p.x*TILE}px, ${p.y*TILE}px)`; worldEl.appendChild(el); p.el=el; game.props.push(p); }
function updatePropSprite(prop,icon){ prop.icon=icon; if(prop.el) prop.el.textContent=icon; }

/* ========= HUD ========= */
function updateCamera(){ const cx=clamp(game.player.x-Math.floor(VIEW_W/2),0,MAP_W-VIEW_W); const cy=clamp(game.player.y-Math.floor(VIEW_H/2),0,MAP_H-VIEW_H); game.camera.x=cx; game.camera.y=cy; worldEl.style.transform=`translate(${-cx*TILE}px, ${-cy*TILE}px)`; }
function updatePlayerPos(){ const pEl=document.getElementById('player'); pEl.style.transform=`translate(${game.player.x*TILE}px, ${game.player.y*TILE}px)`; posLabel.textContent=`${game.player.x},${game.player.y}`; }
function terrainAt(x,y){ if(x<0||y<0||x>=MAP_W||y>=MAP_H) return TERRAIN.GRASS; return game.terrain[y][x]; }
function encRateAt(x,y){ return ENCOUNTER[terrainAt(x,y)]??ENCOUNTER.GRASS; }
function updateTerrainHUD(){ const t=terrainAt(game.player.x,game.player.y); document.getElementById('terrainLabel').textContent=TERRAIN_NAME[t]; document.getElementById('encLabel').textContent=Math.round(encRateAt(game.player.x,game.player.y)*100)+'%'; }
function updateInvHUD(){ invLabel.textContent=`Potion x${game.player.items.potion} | Key x${game.player.items.key}`; }
function flashHUD(msg){ stateLabel.textContent=`${game.mode} ãƒ» ${msg}`; setTimeout(()=>stateLabel.textContent=game.mode,450); }

/* ========= å…¥åŠ› ========= */
const dirMap={ArrowUp:'up',ArrowDown:'down',ArrowLeft:'left',ArrowRight:'right',Enter:'enter','i':'bag','I':'bag','s':'save','S':'save','l':'load','L':'load','q':'journal','Q':'journal'};
window.addEventListener('keydown', e=>{
  const k=e.key;
  if(k==='i'||k==='I'){ toggleBag(); return; }
  if(k==='s'||k==='S'){ openSaveSheet('save'); return; }
  if(k==='l'||k==='L'){ openSaveSheet('load'); return; }
  if(k==='q'||k==='Q'){ openJournal('log'); return; }
  const d=dirMap[e.key]; if(!d) return; if(d==='enter'){ onAction(); return; }
  if(game.dialog.active && game.dialog.choices.length && (d==='left'||d==='right')){ moveChoiceFocus(d==='left'?-1:1); return; }
  onMove(d);
});
document.querySelectorAll('[data-dir]').forEach(b=>b.addEventListener('click',()=>onMove(b.dataset.dir)));
document.getElementById('btnAction').addEventListener('click', onAction);

/* ========= ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç§»å‹• ========= */
function isBlocked(x,y){ const g=game.props.find(p=>p.x===x&&p.y===y&&p.type==='gate'); return !!(g && !g.open); }
function canMoveNow(){ return performance.now()>=game.moveLockUntil; }
function lockMoveFor(ms){ game.moveLockUntil=performance.now()+ms; }
function onMove(dir){
  if(game.mode!=='field'||game.dialog.active||game.bagOpen||game.saveOpen||game.journalOpen) return;
  if(!canMoveNow()) return;
  const p=game.player; let nx=p.x, ny=p.y; if(dir==='up')ny--; else if(dir==='down')ny++; else if(dir==='left')nx--; else if(dir==='right')nx++;
  if(nx<0||ny<0||nx>=MAP_W||ny>=MAP_H) return; if(isBlocked(nx,ny)){ flashHUD('éµãŒå¿…è¦ã â€¦'); return; }
  p.x=nx; p.y=ny; updatePlayerPos(); updateTerrainHUD(); updateCamera(); lockMoveFor(MOVE_DELAY[terrainAt(p.x,p.y)]||100);
  if(Math.random()<encRateAt(p.x,p.y)) startBattle(randomEnemy());
}

/* ========= ä¼šè©± ========= */
let typerTimer=null;
function openDialog(lines,choices=[],onChoice=null){ game.dialog.active=true; game.dialog.lines=lines; game.dialog.index=0; document.getElementById('dialog').classList.add('active'); setChoices(choices,onChoice); typeLine(lines[0]); }
function closeDialog(){ document.getElementById('dialog').classList.remove('active'); clearTimeout(typerTimer);
  game.dialog={active:false,lines:[],index:0,choices:[],onChoice:null,typing:false}; choicesEl.innerHTML=''; choicesEl.classList.remove('active'); }
function nextDialog(){ const d=game.dialog; if(d.typing){ skipType(); return; } d.index++; if(d.index>=d.lines.length){ if(d.choices.length){ showChoices(); } else { closeDialog(); } return; } typeLine(d.lines[d.index]); }
function typeLine(text){ clearTimeout(typerTimer); dialogText.textContent=''; game.dialog.typing=true; let i=0; (function tick(){ dialogText.textContent=text.slice(0,i++); if(i<=text.length){ typerTimer=setTimeout(tick,18);}else{ game.dialog.typing=false; } })(); }
function skipType(){ clearTimeout(typerTimer); game.dialog.typing=false; dialogText.textContent=game.dialog.lines[game.dialog.index]; }
function setChoices(choices,onChoice){ game.dialog.choices=choices||[]; game.dialog.onChoice=onChoice||null;
  if(!choices||!choices.length){ choicesEl.innerHTML=''; choicesEl.classList.remove('active'); return; }
  choicesEl.innerHTML=choices.map((c,i)=>`<button class="choice" data-i="${i}" ${i===0?'autofocus':''}>${c.label}</button>`).join('');
  choicesEl.querySelectorAll('.choice').forEach(btn=>btn.addEventListener('click',()=>choose(parseInt(btn.dataset.i,10))));
}
function showChoices(){ choicesEl.classList.add('active'); focusChoice(0); }
function choose(idx){ const d=game.dialog; const opt=d.choices[idx]; if(!opt) return; if(typeof d.onChoice==='function'){ d.onChoice(opt.value??opt.label); } }
function moveChoiceFocus(delta){ const btns=[...choicesEl.querySelectorAll('.choice')]; if(!btns.length) return; let idx=btns.findIndex(b=>b===document.activeElement); if(idx<0) idx=0; let next=(idx+delta+btns.length)%btns.length; focusChoice(next); }
function focusChoice(i){ const btns=[...choicesEl.querySelectorAll('.choice')]; if(!btns.length) return; btns[i].focus(); }

/* ========= Actionï¼ˆçœ‹æ¿/å®ç®±/ã‚²ãƒ¼ãƒˆï¼‰ ========= */
function onAction(){
  if(game.mode==='battle'||game.bagOpen||game.saveOpen||game.journalOpen) return;
  if(game.dialog.active){ if(game.dialog.choices.length){ const btns=[...choicesEl.querySelectorAll('.choice')]; const idx=btns.findIndex(b=>b===document.activeElement); choose(idx>-1?idx:0); return; } nextDialog(); return; }
  const px=game.player.x, py=game.player.y;
  const near=(type)=>game.props.find(pr=>pr.type===type && Math.abs(px-pr.x)+Math.abs(py-pr.y)===1);
  const gate=near('gate'), chest=near('chest'), sign=near('sign');
  if(gate){
    if(game.player.items.key>0){
      openDialog(['éµç©´ãŒã‚ã‚‹â€¦ è§£éŒ ã—ã¾ã™ã‹ï¼Ÿ'],[{label:'ã¯ã„ï¼ˆéµã‚’ä½¿ã†ï¼‰',value:'useKey'},{label:'ã„ã„ãˆ',value:'cancel'}], v=>{
        if(v==='useKey'){ game.player.items.key--; updateInvHUD(); gate.open=true; updatePropSprite(gate,'ğŸŸ©');
          game.terrain[gate.y][gate.x]=TERRAIN.ROAD; setTimeout(()=>{ gate.el?.remove(); },180);
          game.flags.gateOpen=true; setTaskDone('openGate',true); openDialog(['ã‚«ãƒãƒªâ€¦ ã‚²ãƒ¼ãƒˆãŒ é–‹ã„ãŸï¼']); record('è§£éŒ ','ã‚²ãƒ¼ãƒˆã‚’é–‹ã‘ãŸ'); }
        else openDialog(['ã‚„ã‚ã¦ãŠã“ã†ã€‚']);
      });
    }else openDialog(['éµãŒ ã‹ã‹ã£ã¦ã„ã‚‹â€¦ éµãŒå¿…è¦ã ã€‚']);
    return;
  }
  if(chest){
    openDialog(['å®ç®±ãŒã‚ã‚‹ã€‚ é–‹ã‘ã¾ã™ã‹ï¼Ÿ'],[{label:'ã¯ã„ï¼ˆé–‹ã‘ã‚‹ï¼‰',value:'open'},{label:'ã„ã„ãˆ',value:'no'}], v=>{
      if(v==='open'){ chest.opened=true; updatePropSprite(chest,'ğŸ§°'); game.player.items.key++; updateInvHUD(); game.flags.chestOpened=true; setTaskDone('openChest',true); openDialog(['éµã‚’ 1 ã¤ æ‰‹ã«å…¥ã‚ŒãŸï¼']); record('å…¥æ‰‹','éµã‚’æ‰‹ã«å…¥ã‚ŒãŸ'); }
      else openDialog(['å®ç®±ã‚’ é–‰ã˜ãŸã€‚']);
    }); return;
  }
  if(sign){
    openDialog(['ã“ã“ã¯åºƒã„è¡—é“ã€‚æ£®ã¯é­é‡9%ã€é“ã¯1%ã€‚','ã“ã®å…ˆã®ã‚²ãƒ¼ãƒˆã¯éµã§é–‹ãã€‚åŒ—è¥¿ã«å®ç®±ãŒã‚ã‚‹ã‚‰ã—ã„ã€‚','å›å¾©è–¬ã¯å¿…è¦ã‹ã„ï¼Ÿ'],
      [{label:'ã¯ã„ï¼ˆã‚‚ã‚‰ã†ï¼‰',value:'getPotion'},{label:'ã„ã„ãˆ',value:'skip'}], v=>{
        if(v==='getPotion'){ game.player.items.potion++; updateInvHUD(); openDialog(['å›å¾©è–¬ã‚’ 1 ã¤ æ‰‹ã«å…¥ã‚ŒãŸï¼']); record('å…¥æ‰‹','å›å¾©è–¬ã‚’ã‚‚ã‚‰ã£ãŸ'); }
        else{ openDialog(['ã§ã¯ è‰¯ã„æ—…ã‚’ï¼']); }
        game.flags.signGiven=true; record('ä¼šè©±','çœ‹æ¿ã®åŠ©è¨€ã‚’èã„ãŸ');
      }); return;
  }
  flashHUD('Action!');
}

/* ========= æˆ¦é—˜ï¼šæ’ƒç ´å³åˆ¤å®šï¼‹ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆè¡¨ç¤º ========= */
document.getElementById('actAttack').addEventListener('click',()=>turn('attack'));
document.getElementById('actItem').addEventListener('click',()=>turn('item'));
document.getElementById('actRun').addEventListener('click',()=>turn('run'));
document.getElementById('actEnd').addEventListener('click',()=>endBattle());
document.getElementById('actSkill').addEventListener('click',()=>turn('venom'));

function randomEnemy(){
  const presets=[
    {type:'slime',  name:'ã‚¹ãƒ©ã‚¤ãƒ ', emoji:'ğŸ«§', hp:28, atk:7, def:1,  affinity:{poison:'weak'}, items:{potion:1}},
    {type:'bat',    name:'ã“ã†ã‚‚ã‚Š', emoji:'ğŸ¦‡', hp:24, atk:6, def:2,  affinity:{poison:'immune'}, items:{potion:1}},
    {type:'goblin', name:'ã‚´ãƒ–ãƒªãƒ³', emoji:'ğŸ‘¹', hp:36, atk:9, def:3,  affinity:{poison:'resist'}, items:{potion:1}},
    {type:'tamakoroshi', name:'ãŸã¾å­ã‚ã—',       img:IMG_ASSETS.tamakoroshi, hp:34, atk:8, def:2, affinity:{poison:'normal'}, items:{potion:1}},
    {type:'kuginame',    name:'ãããªã‚ã•ã—ãã˜', img:IMG_ASSETS.kuginame,    hp:30, atk:7, def:3, affinity:{poison:'resist'}, items:{potion:1}},
    {type:'hitomete',    name:'äººç›®æ‰‹',           img:IMG_ASSETS.hitomete,    hp:32, atk:8, def:2, affinity:{poison:'immune'}, items:{potion:1}},
    {type:'hitokazuta',  name:'äººã‚«ãƒ…ã‚¿',         img:IMG_ASSETS.hitokazuta,  hp:38, atk:9, def:3, affinity:{poison:'normal'}, items:{potion:1}},
    {type:'toshiyori',   name:'å¹´å¯„ã‚ŠãŠåŒ–ã‘',     img:IMG_ASSETS.toshiyori,   hp:28, atk:6, def:2, affinity:{poison:'weak'}, items:{potion:1}},
  ];
  const pick=presets[Math.floor(Math.random()*presets.length)];
  return {...pick, hpMax:pick.hp, status:{ poison:{turns:0,dmg:2}, defUp:{turns:0,amount:3} }};
}
function setEnemySprite(enemy){
  enemyStage.innerHTML='';
  if(enemy.img){
    const img = new Image();
    img.className='enemySprite';
    img.alt=enemy.name;
    img.onload = ()=>{ enemyStage.innerHTML=''; enemyStage.appendChild(img); };
    img.onerror = ()=>{
      console.warn('Enemy image failed to load:', enemy.img);
      enemy.img = null; setEnemySprite(enemy);
    };
    img.src = enemy.img + '?v=' + Date.now(); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç ´ã‚Š
  }else if(enemy.emoji){
    const span=document.createElement('span');
    span.textContent=enemy.emoji; span.className='emoji';
    enemyStage.appendChild(span);
  }else{
    const span=document.createElement('span');
    span.textContent='ğŸ‘¾'; span.className='emoji';
    enemyStage.appendChild(span);
  }
}
function startBattle(enemy){
  game.mode='battle'; game.enemy=enemy;
  fieldEl.style.display='none'; battleEl.classList.add('active');
  setEnemySprite(enemy);
  setLog(`${enemy.name} ãŒ ã‚ã‚‰ã‚ã‚ŒãŸï¼`); refreshBars(); stateLabel.textContent='battle';
  record('é­é‡', `${enemy.name} ã¨å‡ºä¼šã£ãŸ`);
}
function setLog(t){ logEl.textContent=t; }
function dmgCalc(atk,def){ const base=Math.max(1, atk - Math.floor(def*0.6)); return base + Math.floor(Math.random()*3); }
function effAtkP(){ const w=game.player.status.weaken; return Math.max(1, game.player.atk - (w?.turns>0 ? (w.atkDown||3):0)); }
function effDefE(){ const d=game.enemy?.status?.defUp; return (game.enemy?.def||0) + (d?.turns>0 ? (d.amount||3):0); }

function tagsForEnemy(e = game.enemy){
  if(!e) return '';
  const t=[]; const ps=e.status?.poison; const du=e.status?.defUp;
  if(ps?.turns>0) t.push(`â˜ ï¸x${ps.turns}`); if(du?.turns>0) t.push(`ğŸ›¡ï¸x${du.turns}`);
  return t.join(' ');
}
function tagsForPlayer(){ const t=[]; const w=game.player.status.weaken; if(w?.turns>0) t.push(`ğŸ”»x${w.turns}`); return t.join(' '); }
function refreshBars(){
  const p=game.player, e=game.enemy || {hp:1,hpMax:1,status:{}};
  pHpBar.style.setProperty('--v', Math.max(0, p.hp/p.hpMax));
  eHpBar.style.setProperty('--v', Math.max(0, e.hp/e.hpMax));
  pHpNum.textContent=`${p.hp}/${p.hpMax} ${tagsForPlayer()}`;
  eHpNum.textContent=`${e.hp}/${e.hpMax} ${tagsForEnemy(e)}`;
  updateInvHUD(); checkEnemyDefeated();
}
function checkEnemyDefeated(){ if(game.mode==='battle' && game.enemy && game.enemy.hp<=0){ win(); } }
function turn(action){
  const p=game.player, e=game.enemy;
  if(action==='attack'){
    const d=dmgCalc(effAtkP(), effDefE()); e.hp=Math.max(0,e.hp-d);
    setLog(`ã‚ãªãŸã® ã“ã†ã’ãï¼ ${e.name} ã« ${d} ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`); shake('enemyBattle');
    refreshBars(); if(e.hp<=0) return; enemyPhase();
  }else if(action==='venom'){
    const first=10; e.hp=Math.max(0,e.hp-first);
    let applied=false, note=''; const aff=e.affinity?.poison||'normal';
    if(aff==='immune'){ note='ã—ã‹ã— æ¯’ã¯åŠ¹ã‹ãªã„ï¼'; }
    else if(aff==='resist'){ if(Math.random()<0.5){ e.status.poison={turns:2,dmg:1}; applied=true; } else note='åŠ¹ãã«ãã„â€¦'; }
    else if(aff==='weak'){ e.status.poison={turns:4,dmg:3}; applied=true; }
    else { e.status.poison={turns:3,dmg:2}; applied=true; }
    setLog(`ã‚¹ã‚­ãƒ«ï¼šãƒ™ãƒãƒ ï¼ åˆæ’ƒ${first}ãƒ€ãƒ¡ãƒ¼ã‚¸${applied?'ï¼†æ¯’ã‚’ä»˜ä¸ï¼':''}${note?`ï¼ˆ${note}ï¼‰`:''}`);
    shake('enemyBattle'); refreshBars(); if(e.hp<=0) return; enemyPhase();
  }else if(action==='item'){
    if(p.items.potion>0 && p.hp>0){
      p.items.potion--; p.hp=Math.min(p.hpMax,p.hp+25);
      setLog(`å›å¾©è–¬ã‚’ä½¿ã£ãŸï¼ HPãŒ25å›å¾©ï¼ˆæ®‹:${p.items.potion}ï¼‰`); refreshBars(); enemyPhase();
    } else setLog('ã‚¢ã‚¤ãƒ†ãƒ ãŒãªã„â€¦');
  }else if(action==='run'){
    if(Math.random()<0.6){ setLog('ã†ã¾ã ã«ã’ãã‚ŒãŸï¼'); endBattle(); }
    else{ setLog('ã«ã’ã‚‰ã‚Œãªã„ï¼'); enemyPhase(); }
  }
}
function enemyPhase(){
  const p=game.player, e=game.enemy;
  if(e.status?.poison?.turns>0){
    e.hp=Math.max(0, e.hp - e.status.poison.dmg);
    e.status.poison.turns--; setLog(`${e.name} ã¯æ¯’ã§ ${e.status.poison.dmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
    refreshBars(); if(e.hp<=0) return;
  }
  const low=e.hp/e.hpMax<0.30, canHeal=e.items?.potion>0;
  if(low && canHeal && Math.random()<0.5){
    e.items.potion--; const heal=Math.floor(e.hpMax*0.30); e.hp=Math.min(e.hpMax,e.hp+heal);
    setLog(`${e.name} ã¯å›å¾©è–¬ã‚’ä½¿ã£ãŸï¼ ${heal} å›å¾©ï¼ˆæ®‹:${e.items.potion||0}ï¼‰`); refreshBars();
  } else {
    if(e.type==='slime' && Math.random()<0.20 && !(e.status.defUp?.turns>0)){
      e.status.defUp={turns:2,amount:3}; setLog('ã‚¹ãƒ©ã‚¤ãƒ ã¯ ã‹ã‚‰ã ã‚’ å›ºãã—ãŸï¼ï¼ˆğŸ›¡ï¸2Tï¼‰'); refreshBars();
    }else if(e.type==='bat' && Math.random()<0.30 && !(p.status.weaken?.turns>0)){
      p.status.weaken.turns=3; setLog('ã“ã†ã‚‚ã‚Šã® ã‚¹ã‚¯ãƒªãƒ¼ãƒï¼ ã‚ãªãŸã® æ”»æ’ƒãŒ ä¸‹ãŒã£ãŸï¼ˆğŸ”»3Tï¼‰'); refreshBars();
    }else if(e.type==='goblin' && Math.random()<0.25){
      const d=dmgCalc(e.atk+2, p.def); p.hp=Math.max(0,p.hp-d);
      setLog(`ã‚´ãƒ–ãƒªãƒ³ã® å¼·æ’ƒï¼ ã‚ãªãŸã¯ ${d} ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`); shake('playerBattle'); refreshBars(); if(p.hp<=0){ lose(); return; }
    }else{
      const d=dmgCalc(e.atk, p.def); p.hp=Math.max(0,p.hp-d);
      setLog(`${e.name} ã® ã“ã†ã’ãï¼ ã‚ãªãŸã¯ ${d} ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`); shake('playerBattle'); refreshBars(); if(p.hp<=0){ lose(); return; }
    }
  }
  if(e.status?.defUp?.turns>0) e.status.defUp.turns--;
  if(p.status?.weaken?.turns>0) p.status.weaken.turns--;
}
function win(){ setLog('ã‹ã¡ã¾ã—ãŸï¼'); document.getElementById('actEnd').style.display='inline-block'; toggleActions(true); record('å‹åˆ©', `${game.enemy.name} ã‚’å€’ã—ãŸ`); }
function lose(){ setLog('ãŸãŠã‚Œã¦ã—ã¾ã£ãŸâ€¦ å›å¾©ã—ã¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¸æˆ»ã‚Šã¾ã™'); game.player.hp=Math.floor(game.player.hpMax*0.6); document.getElementById('actEnd').style.display='inline-block'; toggleActions(true); record('æ•—åŒ—','åŠ›å°½ããŸ'); }
function endBattle(){ game.mode='field'; stateLabel.textContent='field'; document.getElementById('actEnd').style.display='none';
  toggleActions(false); battleEl.classList.remove('active'); fieldEl.style.display=''; game.enemy=null; setLog(''); refreshBars(); }
function toggleActions(disabled){ ['actAttack','actItem','actRun','actSkill'].forEach(id=>document.getElementById(id).disabled=disabled); }
function shake(id){ const el=document.getElementById(id);
  el.animate([{transform:el.style.transform||'none'},{transform:'translateX(-4px)'},{transform:'translateX(4px)'},{transform:'translateX(0)'}],{duration:160,iterations:1}); }

/* ========= ãƒãƒƒã‚° ========= */
const ITEM_DEFS={
  potion:{ emoji:'ğŸ§ª', name:'å›å¾©è–¬', desc:'HPã‚’25å›å¾©ã™ã‚‹ã€‚æˆ¦é—˜å¤–ã§ä½¿ç”¨å¯ã€‚',
    canUse:(ctx)=> ctx.game.mode==='field',
    use:({game})=>{
      if(game.player.items.potion<=0) return toast('å›å¾©è–¬ãŒãªã„â€¦');
      game.player.items.potion--; game.player.hp=Math.min(game.player.hpMax, game.player.hp+25);
      refreshBars(); updateInvHUD(); toast('HPãŒ25å›å¾©ï¼'); record('å›å¾©','å›å¾©è–¬ã‚’ä½¿ç”¨ã—ãŸ');
    }},
  key:{ emoji:'ğŸ—ï¸', name:'éµ', desc:'ã‚²ãƒ¼ãƒˆã®è§£éŒ ã«ä½¿ãˆã‚‹ã€‚Actionã§ä½¿ç”¨ã€‚', canUse:()=>false, use:()=>{} }
};
document.getElementById('btnBag').addEventListener('click',toggleBag);
document.getElementById('btnCloseBag').addEventListener('click',closeBag);
function toggleBag(){ if(game.mode==='battle'||game.saveOpen||game.journalOpen) return; if(game.bagOpen) closeBag(); else openBag(); }
function openBag(){ game.bagOpen=true; bagSheet.classList.add('active'); bagSheet.setAttribute('aria-hidden','false'); renderBag(); }
function closeBag(){ bagSheet.classList.remove('active'); bagSheet.setAttribute('aria-hidden','true'); game.bagOpen=false; }
function renderBag(){
  const items=[{key:'potion',qty:game.player.items.potion},{key:'key',qty:game.player.items.key}];
  bagList.innerHTML=items.map(({key,qty})=>{ const def=ITEM_DEFS[key]; const can=def.canUse({game,toast});
    return `<div class="itemCard">
      <div class="itemHead"><div class="itemName">${def.emoji} ${def.name}</div><div class="qty">x${qty}</div></div>
      <div class="desc">${def.desc}</div>
      <div><button data-use="${key}" ${(!can||qty<=0)?'disabled':''}>ä½¿ã†</button></div>
    </div>`; }).join('');
  bagList.querySelectorAll('[data-use]').forEach(btn=>btn.addEventListener('click',()=>{ ITEM_DEFS[btn.getAttribute('data-use')].use({game,toast}); renderBag(); }));
}

/* ========= ã‚»ãƒ¼ãƒ–ï¼ˆ3ã‚¹ãƒ­ãƒƒãƒˆï¼‰ ========= */
document.getElementById('btnSave').addEventListener('click',()=>openSaveSheet('save'));
document.getElementById('btnLoad').addEventListener('click',()=>openSaveSheet('load'));
document.getElementById('btnCloseSave').addEventListener('click',closeSaveSheet);
tabSave.addEventListener('click',()=>switchSaveMode('save')); tabLoad.addEventListener('click',()=>switchSaveMode('load'));
function openSaveSheet(mode='save'){ if(game.mode==='battle'||game.bagOpen||game.journalOpen) return; game.saveOpen=true; game.saveMode=mode; saveSheet.classList.add('active'); saveSheet.setAttribute('aria-hidden','false'); switchSaveMode(mode); }
function closeSaveSheet(){ saveSheet.classList.remove('active'); saveSheet.setAttribute('aria-hidden','true'); game.saveOpen=false; }
function switchSaveMode(mode){ game.saveMode=mode; tabSave.classList.toggle('active',mode==='save'); tabLoad.classList.toggle('active',mode==='load'); renderSlots(); }
function getSlot(n){ try{ const raw=localStorage.getItem(SAVE_PREFIX+n); return raw?JSON.parse(raw):null; }catch(e){ return null; } }
function putSlot(n,data){ localStorage.setItem(SAVE_PREFIX+n, JSON.stringify(data)); }
function delSlot(n){ localStorage.removeItem(SAVE_PREFIX+n); }
function snap(){ return {version:'v2.0', savedAt:Date.now(), player:JSON.parse(JSON.stringify(game.player)), flags:JSON.parse(JSON.stringify(game.flags)), journal:JSON.parse(JSON.stringify(game.journal))}; }
function applySnap(s){ Object.assign(game.player,s.player||{}); Object.assign(game.flags,s.flags||{}); if(s.journal){ game.journal=JSON.parse(JSON.stringify(s.journal)); }
  updatePlayerPos(); updateTerrainHUD(); updateCamera(); refreshBars(); buildWorld(); }
function slotSummary(s){ if(!s) return {title:'ï¼ˆç©ºãï¼‰',meta:'æœªä¿å­˜',body:'â€”'}; const p=s.player||{}, f=s.flags||{};
  const items=p.items?`P:${p.items.potion??0} / K:${p.items.key??0}`:''; const flags=`Gate:${f.gateOpen?'Open':'Close'} / Chest:${f.chestOpened?'Open':'Close'}`;
  return { title:`HP ${p.hp??'-'}/${p.hpMax??'-'}ã€€åº§æ¨™ ${p.x??'-'},${p.y??'-'}`, meta:`${s.version}ãƒ»${fmtTime(s.savedAt)}`, body:`æ‰€æŒ ${items}ã€€|ã€€${flags}` };
}
function renderSlots(){
  slotList.innerHTML=[1,2,3].map(i=>{
    const s=getSlot(i), sum=slotSummary(s), mode=game.saveMode;
    const actions=mode==='save'
      ? `<button data-act="save" data-i="${i}">${s?'ä¸Šæ›¸ãä¿å­˜':'ä¿å­˜'}</button>`
      : `<button data-act="load" data-i="${i}" ${s?'':'disabled'}>ãƒ­ãƒ¼ãƒ‰</button><button data-act="delete" data-i="${i}" ${s?'':'disabled'}>å‰Šé™¤</button>`;
    return `<div class="slotCard">
      <div class="slotHead"><div>ã‚¹ãƒ­ãƒƒãƒˆ ${i}</div><div class="meta">${sum.meta}</div></div>
      <div class="slotBody">${sum.title}<br>${sum.body}</div>
      <div style="display:flex; gap:8px; justify-content:flex-end">${actions}</div>
    </div>`;
  }).join('');
  slotList.querySelectorAll('[data-act]').forEach(btn=>{
    const act=btn.getAttribute('data-act'); const i=parseInt(btn.getAttribute('data-i'),10);
    btn.addEventListener('click',()=>{
      if(act==='save'){ const exist=getSlot(i); if(exist && !confirm('ã“ã®ã‚¹ãƒ­ãƒƒãƒˆã«ä¸Šæ›¸ãã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return; putSlot(i,snap()); toast2(`ã‚¹ãƒ­ãƒƒãƒˆ ${i} ã«ä¿å­˜ã—ã¾ã—ãŸ`); renderSlots(); }
      else if(act==='load'){ const s=getSlot(i); if(!s){ toast2('ç©ºã®ã‚¹ãƒ­ãƒƒãƒˆã§ã™'); return; } applySnap(s); toast2(`ã‚¹ãƒ­ãƒƒãƒˆ ${i} ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`); closeSaveSheet(); }
      else if(act==='delete'){ if(confirm('ã“ã®ã‚¹ãƒ­ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ delSlot(i); toast2(`ã‚¹ãƒ­ãƒƒãƒˆ ${i} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`); renderSlots(); } }
    });
  });
}

/* ========= ã‚¸ãƒ£ãƒ¼ãƒŠãƒ« ========= */
document.getElementById('btnJournal').addEventListener('click', ()=> openJournal('log'));
document.getElementById('btnCloseJournal').addEventListener('click', closeJournal);
document.getElementById('btnClearLog').addEventListener('click', ()=>{ if(confirm('å‡ºæ¥äº‹ãƒ­ã‚°ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')){ game.journal.entries=[]; renderJournal(); toast3('ãƒ­ã‚°ã‚’æ¶ˆå»ã—ã¾ã—ãŸ'); }});
tabJLog.addEventListener('click', ()=> switchJournalMode('log'));
tabJTask.addEventListener('click', ()=> switchJournalMode('task'));
function openJournal(mode='log'){ if(game.mode==='battle'||game.bagOpen||game.saveOpen) return; game.journalOpen=true; game.journalMode=mode; journalSheet.classList.add('active'); journalSheet.setAttribute('aria-hidden','false'); switchJournalMode(mode); }
function closeJournal(){ journalSheet.classList.remove('active'); journalSheet.setAttribute('aria-hidden','true'); game.journalOpen=false; }
function switchJournalMode(mode){ game.journalMode=mode; document.getElementById('tabJLog').classList.toggle('active', mode==='log'); document.getElementById('tabJTask').classList.toggle('active', mode==='task'); renderJournal(); }
function renderJournal(){
  if(game.journalMode==='log'){
    journalList.innerHTML = game.journal.entries.length
      ? game.journal.entries.map(e=>`
        <div class="logCard">
          <div class="logHead"><div class="chip">${e.tag}</div><div class="meta">${fmtTime(e.t)} ï½œ åº§æ¨™ ${e.x},${e.y}</div></div>
          <div class="logBody">${e.text}</div>
        </div>`).join('')
      : `<div class="muted" style="padding:6px 10px;">ã¾ã å‡ºæ¥äº‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
  }else{
    journalList.innerHTML = game.journal.tasks.map(t=>`
      <div class="taskCard ${t.done?'done':''}">
        <div class="taskHead"><div>${t.done?'âœ…':'ğŸ§­'} ${t.title}</div><div class="meta">${t.done?'<span class="done">å®Œäº†</span>':'é€²è¡Œä¸­'}</div></div>
        <div class="taskBody">${t.done?'ã‚ˆãã§ãã¾ã—ãŸï¼':'ãƒ’ãƒ³ãƒˆï¼šåŒ—è¥¿ã«å®ç®±ï¼ä¸­å¤®æ±ã«ã‚²ãƒ¼ãƒˆ'}</div>
        <div style="display:flex; gap:8px; justify-content:flex-end"><button data-tid="${t.id}" data-act="${t.done?'undone':'done'}">${t.done?'æœªå®Œã«æˆ»ã™':'å®Œäº†ã«ã™ã‚‹'}</button></div>
      </div>`).join('');
    journalList.querySelectorAll('[data-tid]').forEach(btn=>{
      btn.addEventListener('click', ()=>{ const id=btn.getAttribute('data-tid'); const act=btn.getAttribute('data-act'); setTaskDone(id, act==='done'); renderJournal(); });
    });
  }
}

/* ========= åˆæœŸåŒ– ========= */
function syncTasksWithFlags(){ setTaskDone('openChest', !!game.flags.chestOpened); setTaskDone('openGate',  !!game.flags.gateOpen); }
document.getElementById('btnHeal').addEventListener('click', ()=>{ game.player.hp=Math.min(game.player.hpMax, game.player.hp+20); refreshBars(); flashHUD('å›å¾© +20'); });
document.getElementById('btnReset').addEventListener('click', ()=>{
  localStorage.removeItem('miniRPG');
  game.player={ x:Math.floor(MAP_W/2), y:Math.floor(MAP_H/2), hp:60,hpMax:60,atk:12,def:3, items:{potion:2, key:0}, status:{weaken:{turns:0, atkDown:3}} };
  game.flags={ signGiven:false, tutorialDone:false, gateOpen:false, chestOpened:false };
  game.journal.entries=[]; game.journal.tasks.forEach(t=>t.done=false);
  updatePlayerPos(); updateTerrainHUD(); updateCamera(); refreshBars(); buildWorld(); syncTasksWithFlags(); flashHUD('ç¾åœ¨ã®çŠ¶æ…‹ã‚’åˆæœŸåŒ–'); record('åˆæœŸåŒ–','çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ãŸ');
});
function boot(){ genTerrain(); buildWorld(); syncTasksWithFlags(); record('é–‹å§‹','å†’é™ºã‚’å§‹ã‚ãŸ'); }
boot();
</script>
</body>
</html>
