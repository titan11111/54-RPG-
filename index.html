<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>NEO FIELD QUEST</title>
<style>
body{margin:0;background:#0b0f14;color:#e5f1ff;font-family:sans-serif;display:flex;flex-direction:column;align-items:center;overflow:hidden}
canvas{border:2px solid #20ffe3;border-radius:12px;margin:8px;image-rendering:pixelated}
.hud{display:flex;gap:12px;margin:8px}
.panel{background:#0e1520aa;padding:8px 12px;border-radius:8px;border:1px solid #223545}
.hpbar{height:8px;background:#092231;border-radius:6px;overflow:hidden}
.hpfill{height:100%;background:linear-gradient(90deg,#20ffe3,#5df6ff)}
.controller{position:fixed;bottom:20px;width:100%;display:flex;justify-content:space-between;padding:0 40px;pointer-events:none}
.dpad,.buttons{pointer-events:auto}
.dpad{display:grid;grid-template-columns:repeat(3,100px);grid-template-rows:repeat(3,100px);gap:8px}
.dpad button{width:100px;height:100px;font-size:28px;border-radius:20px}
.buttons{display:flex;flex-direction:column;gap:20px}
.buttons button{width:120px;height:100px;font-size:22px;border-radius:20px}
.btn{background:#0a121d;border:1px solid #1e3550;color:#e5f1ff;font-weight:bold}
.btn:active{transform:translateY(1px)}
.A{border-color:#20ffe3;color:#20ffe3}
.B{border-color:#ff4dcb;color:#ff4dcb}
.overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#000c;z-index:5}
.card{background:#08111b;border:2px solid #20ffe3;border-radius:12px;padding:20px;min-width:260px;text-align:center}
.hidden{display:none}
#npcOverlay .card{ text-align:left; font-size:18px; line-height:1.6em; max-width:420px }
</style>
</head>
<body>
<div class="hud">
  <div class="panel">
    <div>HP: <span id="php">30</span>/<span id="pmax">30</span></div>
    <div class="hpbar"><div id="phpfill" class="hpfill"></div></div>
    <div>Â†¥ÊâÄ: <span id="place">ËçâÂéü</span></div>
  </div>
</div>

<canvas id="view" width="256" height="256"></canvas>
<canvas id="minimap" width="128" height="128" style="position:fixed;top:10px;right:10px;border:1px solid #20ffe3"></canvas>

<div class="controller">
  <div class="dpad">
    <div></div><button class="btn" data-dir="up">‚ñ≤</button><div></div>
    <button class="btn" data-dir="left">‚óÄ</button><div></div><button class="btn" data-dir="right">‚ñ∂</button>
    <div></div><button class="btn" data-dir="down">‚ñº</button><div></div>
  </div>
  <div class="buttons">
    <button class="btn A" id="btnA">Ê±∫ÂÆö</button>
    <button class="btn B" id="btnB">„Çπ„ÉÜ„Éº„Çø„Çπ</button>
  </div>
</div>

<!-- NPCÂêπ„ÅçÂá∫„ÅóUI -->
<div id="npcOverlay" class="overlay hidden">
  <div class="card">
    <h2 id="npcName">Êùë‰∫∫</h2>
    <p id="npcLine"></p>
    <button class="btn A" id="npcClose">Èñâ„Åò„Çã</button>
  </div>
</div>

<script>
(()=> {
// ========== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ==========
const $=id=>document.getElementById(id);

// ========== Audio ==========
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();
let bgmInterval=null;

function playBeep(freq=440, duration=0.2, type="square", vol=0.2){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = type;
  osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
  gain.gain.setValueAtTime(vol, audioCtx.currentTime);
  osc.connect(gain).connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration);
}
function sfxMove(){ playBeep(200,0.05,"square",0.1); }
function sfxAttack(){ playBeep(600,0.1,"sawtooth",0.2); }
function sfxDamage(){ playBeep(120,0.2,"triangle",0.2); }
function sfxHeal(){ playBeep(800,0.15,"sine",0.2); }
function sfxFanfare(){
  playBeep(600,0.15,"square");
  setTimeout(()=>playBeep(800,0.15,"square"),200);
  setTimeout(()=>playBeep(1000,0.3,"square"),400);
}
function stopBGM(){ clearInterval(bgmInterval); bgmInterval=null; }
function startFieldBGM(){
  if(bgmInterval) return;
  const notes=[262,330,392,523];
  let i=0;
  bgmInterval=setInterval(()=>{
    playBeep(notes[i%notes.length],0.25,"sine",0.05);
    i++;
  },500);
}
function startBattleBGM(){
  if(bgmInterval) return;
  const notes=[220,262,294,330];
  let i=0;
  bgmInterval=setInterval(()=>{
    playBeep(notes[i%notes.length],0.15,"square",0.08);
    i++;
  },250);
}

// ========== „Éû„ÉÉ„Éó/„Éó„É¨„Ç§„É§„Éº ==========
const TILE=16, W=64, H=64;
const T={GRASS:0,TOWN:1,CASTLE:2,CAVE:3,VILLAGE:4,TEMPLE:5,FOREST:6,RIVER:7};
let map=[...Array(H)].map(()=>Array(W).fill(T.GRASS));
for(let y=0;y<H;y++){
  for(let x=0;x<W;x++){
    if(Math.random()<0.1) map[y][x]=T.FOREST;
    if(Math.random()<0.05) map[y][x]=T.RIVER;
  }
}
map[5][5]=T.CASTLE; map[30][32]=T.CAVE; map[10][20]=T.TOWN;
map[40][50]=T.VILLAGE; map[25][45]=T.TEMPLE;

const player={x:2,y:2,hp:30,max:30};

// ========== NPC ==========
const npcs=[
  {x:6,y:6,type:"town"},
  {x:56,y:21,type:"village"},
  {x:40,y:10,type:"field"}
];
const npcDialog={
  town:[
    "„Çà„ÅÜ„Åì„Åù„ÄÅÂãáËÄÖÊßò„ÄÇ„Åì„ÅÆÁî∫„ÅØÂπ≥Âíå„Åù„ÅÆ„ÇÇ„ÅÆ„Åß„Åô„ÄÇ",
    "Âåó„Å´Âüé„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÁéãÊßò„Åå„ÅäÂæÖ„Å°„Åß„Åô„Çà„ÄÇ"
  ],
  village:[
    "„Åä„ÅÜ„ÄÅÂãáËÄÖÔºÅÂÖÉÊ∞ó„Åù„ÅÜ„Å†„Å™„ÄÇ",
    "Ê¥ûÁ™ü„Å´„ÅØËøë„Å•„Åè„Å™„Çà„ÄÇÈ≠îÁéã„Åå„ÅÑ„Çã„Çì„Å†„Åã„Çâ„Å™ÔºÅ"
  ],
  field:[
    "ÊóÖ„ÅØÊ•Ω„Åó„ÅÑ„ÅãÔºüÁßÅ„ÅØÊôØËâ≤„ÇíÁú∫„ÇÅ„Å¶„ÅÑ„Çã„Å†„Åë„ÅßÂπ∏„Åõ„Åï„ÄÇ",
    "Ê£Æ„Å´„ÅØÁèç„Åó„ÅÑÈ≠îÁâ©„ÅåÂá∫„Çã„Åû„ÄÅÊ∞ó„Çí„Å§„Åë„Å™ÔºÅ"
  ]
};
function talkToNPC(type){
  let line="‚Ä¶", name="Êùë‰∫∫";
  if(type==="town"){ line=npcDialog.town[Math.floor(Math.random()*npcDialog.town.length)]; name="Áî∫„ÅÆÊùë‰∫∫"; }
  else if(type==="village"){ line=npcDialog.village[Math.floor(Math.random()*npcDialog.village.length)]; name="Êùë„ÅÆÊùë‰∫∫"; }
  else{ line=npcDialog.field[Math.floor(Math.random()*npcDialog.field.length)]; name="ÊóÖ„ÅÆ‰∫∫"; }
  $("npcName").textContent=name;
  $("npcLine").textContent=line;
  $("npcOverlay").classList.remove("hidden");
}
$("npcClose").onclick=()=>{ $("npcOverlay").classList.add("hidden"); };

// NPC„Çí„É©„É≥„ÉÄ„É†„Å´Âãï„Åã„Åô
function moveNPCs(){
  for(const npc of npcs){
    if(Math.random()<0.5) continue;
    const dir=[[1,0],[-1,0],[0,1],[0,-1]][Math.floor(Math.random()*4)];
    const nx=npc.x+dir[0], ny=npc.y+dir[1];
    if(nx<0||ny<0||nx>=W||ny>=H) continue;
    if(map[ny][nx]===T.RIVER) continue;
    npc.x=nx; npc.y=ny;
  }
  draw();
}
setInterval(moveNPCs,1000);

// ========== ÊèèÁîª ==========
const view=$("view"),ctx=view.getContext("2d");
const mini=$("minimap"),mctx=mini.getContext("2d");

function draw(){
  ctx.fillStyle="#000";ctx.fillRect(0,0,view.width,view.height);
  const half=8,cx=player.x,cy=player.y;
  for(let dy=-half;dy<=half;dy++){
    for(let dx=-half;dx<=half;dx++){
      const mx=cx+dx,my=cy+dy;
      if(mx<0||my<0||mx>=W||my>=H) continue;
      let t=map[my][mx],emoji="";
      if(t===T.TOWN) emoji="üèòÔ∏è";
      if(t===T.CASTLE) emoji="üè∞";
      if(t===T.CAVE) emoji="üï≥Ô∏è";
      if(t===T.VILLAGE) emoji="üõñ";
      if(t===T.TEMPLE) emoji="üèõÔ∏è";
      if(t===T.FOREST) emoji="üå≥";
      const px=(dx+half)*TILE,py=(dy+half)*TILE;
      ctx.fillStyle="#1c1c1c";ctx.fillRect(px,py,TILE,TILE);
      if(emoji) ctx.fillText(emoji,px+2,py+14);
    }
  }
  ctx.fillText("üèÉ‚Äç‚ôÇÔ∏è‚Äç‚û°Ô∏è",half*TILE+2,half*TILE+14);

  // NPCÊèèÁîª
  for(const npc of npcs){
    let emoji="üë§";
    if(npc.type==="town") emoji="üë®";
    if(npc.type==="village") emoji="üë©";
    if(npc.type==="field") emoji="üßô‚Äç‚ôÇÔ∏è";
    const px=(npc.x-cx+half)*TILE, py=(npc.y-cy+half)*TILE;
    if(px>=0&&py>=0&&px<view.width&&py<view.height){
      ctx.fillText(emoji,px+2,py+14);
    }
  }

  drawMiniMap();
}
function drawMiniMap(){
  const scale=2;
  mctx.fillStyle="#000";mctx.fillRect(0,0,mini.width,mini.height);
  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      const t=map[y][x];
      if(t===T.RIVER){ mctx.fillStyle="#2048ff"; }
      else if(t===T.FOREST){ mctx.fillStyle="#0a3"; }
      else if(t!==T.GRASS){ mctx.fillStyle="#888"; }
      else continue;
      mctx.fillRect(x*scale,y*scale,scale,scale);
    }
  }
  mctx.fillStyle="#fff";
  [T.TOWN,T.CASTLE,T.CAVE,T.VILLAGE,T.TEMPLE].forEach(tt=>{
    for(let y=0;y<H;y++)for(let x=0;x<W;x++){
      if(map[y][x]===tt) mctx.fillRect(x*scale,y*scale,scale,scale);
    }
  });
  mctx.fillStyle="orange";
  mctx.fillRect(player.x*scale,player.y*scale,scale,scale);
}

// ========== ÁßªÂãï ==========
function move(dx,dy){
  const nx=player.x+dx,ny=player.y+dy;
  if(nx<0||ny<0||nx>=W||ny>=H) return;
  if(map[ny][nx]===T.RIVER) return;
  player.x=nx;player.y=ny;sfxMove();
  draw();
}
document.querySelectorAll(".dpad .btn").forEach(b=>{
  b.onclick=()=>{const d=b.dataset.dir;if(d==="up")move(0,-1);if(d==="down")move(0,1);if(d==="left")move(-1,0);if(d==="right")move(1,0);}
});

// Ê±∫ÂÆö„Éú„Çø„É≥„ÅßNPC‰ºöË©±Âà§ÂÆö
$("btnA").onclick=()=>{
  for(const npc of npcs){
    if(player.x===npc.x && player.y===npc.y){
      talkToNPC(npc.type);
    }
  }
};

draw();
startFieldBGM();

})();
</script>
</body>
</html>
