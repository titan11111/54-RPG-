<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>DQ風・RPG土台 v2.0（撃破確定＋5体追加＋2倍スプライト／images参照）</title>
<style>
  :root{
    --panel:#101823; --panel2:#0f1420; --text:#e7f0ff; --muted:#98a3b3; --ok:#2ee59d; --acc:#79e3ff; --acc2:#9bf570; --danger:#ff6b6b;
    --grid:48;
  }
  *{box-sizing:border-box}
  body{ margin:0; background:linear-gradient(180deg,#0a0f1a,#06080f); color:var(--text);
        font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
        display:flex; min-height:100svh; align-items:center; justify-content:center; }
  .wrap{ width:min(100vw,900px); padding:12px; display:grid; gap:12px; grid-template-rows:auto 1fr auto; }
  header{ display:flex; gap:8px; align-items:center; justify-content:space-between;
          background:linear-gradient(180deg,rgba(255,255,255,.06),transparent);
          padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.06); box-shadow:inset 0 0 0 1px rgba(255,255,255,.03); }
  header .title{font-weight:700; letter-spacing:.02em}
  .btns{display:flex; gap:8px; flex-wrap:wrap}
  button{ appearance:none; border:none; color:var(--text); background:var(--panel);
          padding:10px 14px; border-radius:10px; font-weight:600; letter-spacing:.02em; border:1px solid rgba(255,255,255,.08); }
  button:hover{filter:brightness(1.1)} button:active{transform:translateY(1px)} button[disabled]{opacity:.5; pointer-events:none}

  .screen{ position:relative; border-radius:16px; overflow:hidden;
           background:radial-gradient(80% 100% at 50% 0%, #0c1625, #050812 80%);
           border:1px solid rgba(255,255,255,.08); aspect-ratio:16/9; min-height:360px; }

  /* === フィールド / HUD === */
  .field{ position:absolute; inset:0; display:grid; grid-template-rows:auto 1fr; }
  .hud{ display:flex; gap:12px; padding:8px 12px; background:rgba(0,0,0,.25); border-bottom:1px solid rgba(255,255,255,.08); backdrop-filter: blur(6px); }
  .badge{ padding:6px 10px; border-radius:8px; background:var(--panel); border:1px solid rgba(255,255,255,.06); font-size:12px; color:var(--muted) }
  .hintMove{color:var(--muted); margin-left:auto; font-size:12px}
  .viewport{ position:relative; margin:12px; border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,.08);
             background:#0b1422; width:calc(var(--grid)*9px); height:calc(var(--grid)*9px); }
  .world{ position:absolute; left:0; top:0; will-change:transform; }
  .tile{ position:absolute; width:calc(var(--grid)*1px); height:calc(var(--grid)*1px); outline:1px solid rgba(255,255,255,.03); display:grid; place-items:center; font-size:18px; }
  .t-grass{ background:linear-gradient(180deg,#0c1f2c,#0d2a2a) } .t-forest{ background:linear-gradient(180deg,#0f1f18,#0c2617) } .t-road{ background:linear-gradient(180deg,#1a1a24,#15151d) }
  .player,.prop{ position:absolute; width:calc(var(--grid)*1px); height:calc(var(--grid)*1px);
                 display:grid; place-items:center; font-size:22px; filter:drop-shadow(0 6px 8px rgba(0,0,0,.4)); transition:transform .12s ease-out; }
  .prop{ font-size:20px }

  /* === 会話 === */
  .dialog{ position:absolute; left:8px; right:8px; bottom:8px; padding:12px; background:rgba(10,15,25,.9);
           border:1px solid rgba(255,255,255,.12); border-radius:12px; display:none; z-index:5; }
  .dialog.active{ display:block; }
  .dialog .name{ font-weight:700; color:var(--acc2); margin-bottom:6px; }
  .dialog .text{ min-height:44px }
  .choices{ display:none; margin-top:10px; gap:8px; }
  .choices.active{ display:flex; flex-wrap:wrap; }
  .choice{ flex:1 1 120px; padding:10px 12px; border-radius:10px; background:linear-gradient(180deg,#1c2a44,#101b2f); border:1px solid rgba(255,255,255,.12); text-align:center; }
  .choice:focus{ outline:2px solid var(--acc); }

  /* === 戦闘 === */
  .battle{ position:absolute; inset:0; display:none; grid-template-rows:1fr auto; padding:12px; }
  .battle.active{ display:grid }
  .battleStage{ border-radius:12px; border:1px solid rgba(255,255,255,.08);
                background: radial-gradient(60% 60% at 50% 20%, #172238, transparent 60%), linear-gradient(180deg,#0b0f1a,#050812);
                position:relative; overflow:hidden; }
  .battleUI{ margin-top:12px; display:grid; gap:10px; grid-template-columns:1fr; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:linear-gradient(180deg, var(--panel), var(--panel2)); }
  .row{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
  .hpbar{ --v:1; inline-size:180px; block-size:12px; border-radius:999px; background:#1d2a3d; overflow:hidden; border:1px solid rgba(255,255,255,.08); }
  .hpbar>i{ display:block; width:calc(var(--v) * 100%); height:100%; background:linear-gradient(90deg,var(--ok),#ffee58)}
  .hpnum{font-variant-numeric:tabular-nums; min-width:160px; text-align:right; white-space:nowrap }

  /* 敵スプライト（最前面＆くっきり） */
  #enemyBattle{
    position:absolute; right:24px; top:32px;
    display:grid; place-items:center;
    width:200px; height:200px;
    z-index:2;
  }
  #enemyBattle .emoji{
    font-size:88px; transform:scale(1.25);
    filter: drop-shadow(0 10px 18px rgba(0,0,0,.5));
  }
  .enemySprite{
    width:200px; height:200px;
    object-fit:contain; object-position:center;
    image-rendering:auto;
    filter: drop-shadow(0 10px 18px rgba(0,0,0,.5));
    mix-blend-mode:normal !important; /* ← 背景っぽくならない */
    opacity:1; z-index:2; pointer-events:none;
  }

  /* 勇者2倍（バトル） */
  #playerBattle{ font-size:44px; filter: drop-shadow(0 10px 18px rgba(0,0,0,.5)); }

  /* （任意）フィールド上の勇者も2倍にしたいなら有効化
  #player{ font-size:44px; }
  */
  
  /* === シート（バッグ／セーブ／ログ） === */
  .sheetWrap{ position:absolute; left:0; right:0; bottom:0; pointer-events:none; z-index:6; }
  .sheet{ margin:0 auto; max-width:860px; translate:0 100%; pointer-events:auto; transition:translate .25s ease-out;
          background:linear-gradient(180deg,#121b2b,#0b1320); border-top-left-radius:16px; border-top-right-radius:16px;
          border:1px solid rgba(255,255,255,.10); border-bottom:none; box-shadow:0 -16px 40px rgba(0,0,0,.5); }
  .sheet.active{ translate:0 0 }
  .sheetHead{ display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid rgba(255,255,255,.08) }
  .sheetBody{ padding:10px; display:grid; gap:10px; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); }
  .itemCard,.slotCard,.logCard,.taskCard{ background:linear-gradient(180deg,#162235,#0f1828); border:1px solid rgba(255,255,255,.10); border-radius:12px; padding:12px; display:grid; gap:8px; }
  .itemHead,.slotHead,.logHead,.taskHead{ display:flex; gap:8px; align-items:center; justify-content:space-between }
  .itemName{ font-weight:700 }
  .qty{ color:var(--muted); font-variant-numeric:tabular-nums }
  .desc{ color:var(--muted); font-size:13px; min-height:2.2em }
  .toast{ position:absolute; left:50%; bottom:calc(100% + 8px); translate:-50% 10px; opacity:0; background:#0b1320; border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:8px 12px; transition:.25s ease; font-size:14px }
  .toast.show{ translate:-50% 0; opacity:1 }

  /* セーブ */
  .saveWrap{ z-index:7 }
  .modeTabs{ display:flex; gap:6px; } .tabBtn{ padding:8px 12px; border-radius:10px; background:linear-gradient(180deg,#1c2a44,#101b2f); border:1px solid rgba(255,255,255,.12); }
  .tabBtn.active{ outline:2px solid var(--acc) }
  .meta{ color:var(--muted); font-size:12px }
  .slotBody{ color:var(--muted); font-size:13px; line-height:1.5 }

  /* ログ */
  .journalWrap{ z-index:8 }
  .jTabs{ display:flex; gap:6px; }
  .chip{ font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--muted) }
  .done{ color:var(--acc2) }
  .muted{ color:var(--muted) }
  .logBody{ color:var(--muted); font-size:13px; line-height:1.5 }
  .taskBody{ color:var(--muted); font-size:13px; line-height:1.5 }
  .taskCard.done{ opacity:.85; box-shadow:inset 0 0 0 1px rgba(155,245,112,.25); }

  /* モバイル操作 */
  .controls{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:4px; }
  .dpad{ display:grid; grid-template-areas: ". up ." "left center right" ". down ."; gap:6px; justify-items:center; align-items:center; }
  .dpad button{ width:56px; height:56px; border-radius:14px; background:linear-gradient(180deg,#132235,#0c1522) }
  .dpad .up{grid-area:up} .dpad .down{grid-area:down} .dpad .left{grid-area:left} .dpad .right{grid-area:right}
  .act{ display:grid; align-content:center; justify-items:stretch; gap:8px; }
  .act button{ height:56px; border-radius:14px; background:linear-gradient(180deg,#1c2a44,#101b2f) }
  .footnote{ color:var(--muted); font-size:12px; text-align:center }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">DQ風・RPG土台 v2.0（撃破確定＋5体追加＋2倍）</div>
    <div class="btns">
      <button id="btnBag">バッグ (I)</button>
      <button id="btnJournal">ログ (Q)</button>
      <button id="btnSave">セーブ (S)</button>
      <button id="btnLoad">ロード (L)</button>
      <button id="btnHeal">回復(+20HP)</button>
      <button id="btnReset">初期化</button>
    </div>
  </header>

  <main class="screen">
    <!-- フィールド -->
    <section class="field" id="field">
      <div class="hud">
        <span class="badge">状態: <b id="stateLabel">field</b></span>
        <span class="badge">座標: <b id="posLabel">0,0</b></span>
        <span class="badge">地形: <b id="terrainLabel">-</b></span>
        <span class="badge">遭遇率: <b id="encLabel">-</b></span>
        <span class="badge">所持: <b id="invLabel">Potion x0 | Key x0</b></span>
        <span class="hintMove">移動コスト：道&lt;草原&lt;森</span>
      </div>
      <div class="viewport" id="viewport"><div class="world" id="world"></div></div>

      <!-- 会話 -->
      <div class="dialog" id="dialog">
        <div class="name" id="dialogName">🪧 看板</div>
        <div class="text" id="dialogText"></div>
        <div class="choices" id="choices"></div>
        <div class="hint">Enter / Actionで決定・次へ</div>
      </div>

      <!-- バッグ／セーブ／ジャーナル -->
      <div class="sheetWrap"><div class="sheet" id="bagSheet" aria-hidden="true">
        <div class="sheetHead"><div style="font-weight:700">🎒 バッグ</div><div><button id="btnCloseBag">閉じる</button></div></div>
        <div class="sheetBody" id="bagList"></div><div class="toast" id="toast"></div></div></div>

      <div class="sheetWrap saveWrap"><div class="sheet" id="saveSheet" aria-hidden="true">
        <div class="sheetHead"><div style="display:flex; align-items:center; gap:10px;">
          <div style="font-weight:700">💾 記録</div>
          <div class="modeTabs"><button class="tabBtn" id="tabSave">保存</button><button class="tabBtn" id="tabLoad">読込</button></div>
        </div><div><button id="btnCloseSave">閉じる</button></div></div>
        <div class="sheetBody" id="slotList"></div><div class="toast" id="toastSave"></div></div></div>

      <div class="sheetWrap journalWrap"><div class="sheet" id="journalSheet" aria-hidden="true">
        <div class="sheetHead"><div style="display:flex; align-items:center; gap:10px;">
          <div style="font-weight:700">📜 ログ</div>
          <div class="jTabs"><button class="tabBtn" id="tabJLog">出来事</button><button class="tabBtn" id="tabJTask">クエスト</button></div>
        </div><div style="display:flex; gap:8px;"><button id="btnClearLog">ログ消去</button><button id="btnCloseJournal">閉じる</button></div></div>
        <div class="sheetBody" id="journalList"></div><div class="toast" id="toastJournal"></div></div></div>
    </section>

    <!-- 戦闘 -->
    <section class="battle" id="battle">
      <div class="battleStage">
        <div class="player" id="playerBattle" style="left:24px; top:56px">🧝</div>
        <div id="enemyBattle"></div>
      </div>
      <div class="battleUI">
        <div class="row"><div>プレイヤーHP</div><div class="hpbar"><i id="pHpBar"></i></div><div class="hpnum" id="pHpNum"></div></div>
        <div class="row"><div>エネミーHP</div><div class="hpbar"><i id="eHpBar"></i></div><div class="hpnum" id="eHpNum"></div></div>
        <div class="row"><div class="log" id="log">エンカウント！</div></div>
        <div class="row">
          <button id="actAttack">こうげき</button>
          <button id="actSkill">スキル：ベノム</button>
          <button id="actItem">アイテム(回復薬)</button>
          <button id="actRun">にげる</button>
          <button id="actEnd" style="display:none;">フィールドへ</button>
        </div>
      </div>
    </section>
  </main>

  <section class="controls">
    <div class="dpad">
      <button class="up" data-dir="up">▲</button>
      <button class="left" data-dir="left">◀</button>
      <button class="right" data-dir="right">▶</button>
      <button class="down" data-dir="down">▼</button>
      <button class="center" disabled style="opacity:.3;">＋</button>
    </div>
    <div class="act">
      <button id="btnAction">Action / 決定</button>
      <div class="footnote">PC: 矢印/Enter / I(バッグ) / Q(ログ) / S(保存) / L(読込)</div>
    </div>
  </section>
</div>

<script>
/* ========= 画像アセット =========
  透明PNG推奨。フォルダは images/ （index.html と同階層） */
const IMG_ASSETS = {
  slime:   null, // スライムは絵文字
  tamakoroshi: 'images/tamakoroshi.png',
  kuginame:    'images/kuginame-sashikuji.png',
  hitomete:    'images/hitomete.png',
  hitokazuta:  'images/hitokazuta.png',
  toshiyori:   'images/toshiyori-obake.png'
};
/* ========= 基本定数／状態 ========= */
const MAP_W=20, MAP_H=15, VIEW_W=9, VIEW_H=9;
const TILE=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--grid'));
const TERRAIN={GRASS:'GRASS',FOREST:'FOREST',ROAD:'ROAD'};
const TERRAIN_NAME={GRASS:'草原',FOREST:'森',ROAD:'道'};
const ENCOUNTER={GRASS:0.05,FOREST:0.09,ROAD:0.01};
const MOVE_DELAY={GRASS:90,FOREST:230,ROAD:40};
const SAVE_PREFIX='miniRPG_s';

const worldEl=document.getElementById('world');
const stateLabel=document.getElementById('stateLabel');
const posLabel=document.getElementById('posLabel');
const terrLabel=document.getElementById('terrainLabel');
const encLabel=document.getElementById('encLabel');
const invLabel=document.getElementById('invLabel');

const dialogEl=document.getElementById('dialog');
const dialogText=document.getElementById('dialogText');
const choicesEl=document.getElementById('choices');

const bagSheet=document.getElementById('bagSheet');
const bagList=document.getElementById('bagList');
const toastEl=document.getElementById('toast');

const saveSheet=document.getElementById('saveSheet');
const slotList=document.getElementById('slotList');
const toastSave=document.getElementById('toastSave');
const tabSave=document.getElementById('tabSave');
const tabLoad=document.getElementById('tabLoad');

const journalSheet=document.getElementById('journalSheet');
const journalList=document.getElementById('journalList');
const toastJournal=document.getElementById('toastJournal');
const tabJLog=document.getElementById('tabJLog');
const tabJTask=document.getElementById('tabJTask');

const battleEl=document.getElementById('battle'), fieldEl=document.getElementById('field');
const logEl=document.getElementById('log'); const pHpBar=document.getElementById('pHpBar'), eHpBar=document.getElementById('eHpBar');
const pHpNum=document.getElementById('pHpNum'), eHpNum=document.getElementById('eHpNum');
const enemyStage=document.getElementById('enemyBattle');

const game={
  mode:'field',
  player:{ x:Math.floor(MAP_W/2), y:Math.floor(MAP_H/2), hp:60,hpMax:60,atk:12,def:3,
           items:{potion:2,key:0}, status:{weaken:{turns:0, atkDown:3}} },
  enemy:null,
  terrain:[], props:[],
  camera:{x:0,y:0},
  dialog:{active:false,lines:[],index:0,choices:[],onChoice:null,typing:false},
  flags:{signGiven:false,tutorialDone:false,gateOpen:false,chestOpened:false},
  moveLockUntil:0,
  bagOpen:false, saveOpen:false, journalOpen:false,
  saveMode:'save', journalMode:'log',
  journal:{ entries:[], tasks:[ {id:'openChest', title:'北西の宝箱を開ける', done:false}, {id:'openGate', title:'ゲートを開ける', done:false} ] }
};

/* ========= 便利関数 ========= */
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}
function toast(msg){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),1200); }
function toast2(msg){ toastSave.textContent=msg; toastSave.classList.add('show'); setTimeout(()=>toastSave.classList.remove('show'),1200); }
function toast3(msg){ toastJournal.textContent=msg; toastJournal.classList.add('show'); setTimeout(()=>toastJournal.classList.remove('show'),1200); }
function fmtTime(ts){ const d=new Date(ts); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function record(tag,text){ game.journal.entries.unshift({t:Date.now(),tag,text,x:game.player.x,y:game.player.y}); if(game.journal.entries.length>60) game.journal.entries.pop(); if(game.journalOpen && game.journalMode==='log') renderJournal(); }
function setTaskDone(id,done=true){ const t=game.journal.tasks.find(x=>x.id===id); if(t){ t.done=!!done; if(game.journalOpen && game.journalMode==='task') renderJournal(); }}

/* ========= マップ生成/ビルド ========= */
function genTerrain(){ game.terrain=Array.from({length:MAP_H},()=>Array.from({length:MAP_W},()=>TERRAIN.GRASS));
  for(let k=0;k<24;k++){ const cx=Math.floor(Math.random()*MAP_W), cy=Math.floor(Math.random()*MAP_H); const r=1+Math.floor(Math.random()*2);
    for(let y=-r;y<=r;y++)for(let x=-r;x<=r;x++){ const nx=cx+x, ny=cy+y; if(nx>=0&&ny>=0&&nx<MAP_W&&ny<MAP_H && Math.hypot(x,y)<=r+0.3) game.terrain[ny][nx]=TERRAIN.FOREST; } }
  const ry=Math.floor(MAP_H/2), rx=Math.floor(MAP_W/2); for(let x=0;x<MAP_W;x++) game.terrain[ry][x]=TERRAIN.ROAD; for(let y=0;y<MAP_H;y++) game.terrain[y][rx]=TERRAIN.ROAD;
}
function buildWorld(){
  worldEl.innerHTML=''; worldEl.style.width=(MAP_W*TILE)+'px'; worldEl.style.height=(MAP_H*TILE)+'px';
  for(let y=0;y<MAP_H;y++)for(let x=0;x<MAP_W;x++){ const t=document.createElement('div');
    t.className='tile '+(game.terrain[y][x]===TERRAIN.FOREST?'t-forest':game.terrain[y][x]===TERRAIN.ROAD?'t-road':'t-grass');
    t.style.left=(x*TILE)+'px'; t.style.top=(y*TILE)+'px'; const r=Math.random(); if(game.terrain[y][x]===TERRAIN.FOREST && r<0.18) t.textContent='🌲'; else if(game.terrain[y][x]===TERRAIN.GRASS && r<0.07) t.textContent='🌿'; worldEl.appendChild(t); }
  const rx=Math.floor(MAP_W/2), ry=Math.floor(MAP_H/2);
  game.props=[]; addProp({x:rx+2,y:ry,type:'sign',name:'🪧 看板',icon:'🪧'});
  const gatePos={x:rx+6,y:ry}; if(game.flags.gateOpen){ game.terrain[gatePos.y][gatePos.x]=TERRAIN.ROAD; } else { addProp({x:gatePos.x,y:ry,type:'gate',name:'🚧 ゲート',icon:'🚧',open:false}); }
  const chestPos={x:rx-6,y:ry-2}; addProp({x:chestPos.x,y:chestPos.y,type:'chest',name:'📦 宝箱',icon:game.flags.chestOpened?'🧰':'📦',opened: game.flags.chestOpened});
  const p=document.createElement('div'); p.id='player'; p.className='player'; p.textContent='🧝'; worldEl.appendChild(p);
  updatePlayerPos(); updateInvHUD(); updateTerrainHUD(); updateCamera();
}
function addProp(p){ const el=document.createElement('div'); el.className='prop'; el.textContent=p.icon||'❓'; el.style.transform=`translate(${p.x*TILE}px, ${p.y*TILE}px)`; worldEl.appendChild(el); p.el=el; game.props.push(p); }
function updatePropSprite(prop,icon){ prop.icon=icon; if(prop.el) prop.el.textContent=icon; }

/* ========= HUD ========= */
function updateCamera(){ const cx=clamp(game.player.x-Math.floor(VIEW_W/2),0,MAP_W-VIEW_W); const cy=clamp(game.player.y-Math.floor(VIEW_H/2),0,MAP_H-VIEW_H); game.camera.x=cx; game.camera.y=cy; worldEl.style.transform=`translate(${-cx*TILE}px, ${-cy*TILE}px)`; }
function updatePlayerPos(){ const pEl=document.getElementById('player'); pEl.style.transform=`translate(${game.player.x*TILE}px, ${game.player.y*TILE}px)`; posLabel.textContent=`${game.player.x},${game.player.y}`; }
function terrainAt(x,y){ if(x<0||y<0||x>=MAP_W||y>=MAP_H) return TERRAIN.GRASS; return game.terrain[y][x]; }
function encRateAt(x,y){ return ENCOUNTER[terrainAt(x,y)]??ENCOUNTER.GRASS; }
function updateTerrainHUD(){ const t=terrainAt(game.player.x,game.player.y); document.getElementById('terrainLabel').textContent=TERRAIN_NAME[t]; document.getElementById('encLabel').textContent=Math.round(encRateAt(game.player.x,game.player.y)*100)+'%'; }
function updateInvHUD(){ invLabel.textContent=`Potion x${game.player.items.potion} | Key x${game.player.items.key}`; }
function flashHUD(msg){ stateLabel.textContent=`${game.mode} ・ ${msg}`; setTimeout(()=>stateLabel.textContent=game.mode,450); }

/* ========= 入力 ========= */
const dirMap={ArrowUp:'up',ArrowDown:'down',ArrowLeft:'left',ArrowRight:'right',Enter:'enter','i':'bag','I':'bag','s':'save','S':'save','l':'load','L':'load','q':'journal','Q':'journal'};
window.addEventListener('keydown', e=>{
  const k=e.key;
  if(k==='i'||k==='I'){ toggleBag(); return; }
  if(k==='s'||k==='S'){ openSaveSheet('save'); return; }
  if(k==='l'||k==='L'){ openSaveSheet('load'); return; }
  if(k==='q'||k==='Q'){ openJournal('log'); return; }
  const d=dirMap[e.key]; if(!d) return; if(d==='enter'){ onAction(); return; }
  if(game.dialog.active && game.dialog.choices.length && (d==='left'||d==='right')){ moveChoiceFocus(d==='left'?-1:1); return; }
  onMove(d);
});
document.querySelectorAll('[data-dir]').forEach(b=>b.addEventListener('click',()=>onMove(b.dataset.dir)));
document.getElementById('btnAction').addEventListener('click', onAction);

/* ========= フィールド移動 ========= */
function isBlocked(x,y){ const g=game.props.find(p=>p.x===x&&p.y===y&&p.type==='gate'); return !!(g && !g.open); }
function canMoveNow(){ return performance.now()>=game.moveLockUntil; }
function lockMoveFor(ms){ game.moveLockUntil=performance.now()+ms; }
function onMove(dir){
  if(game.mode!=='field'||game.dialog.active||game.bagOpen||game.saveOpen||game.journalOpen) return;
  if(!canMoveNow()) return;
  const p=game.player; let nx=p.x, ny=p.y; if(dir==='up')ny--; else if(dir==='down')ny++; else if(dir==='left')nx--; else if(dir==='right')nx++;
  if(nx<0||ny<0||nx>=MAP_W||ny>=MAP_H) return; if(isBlocked(nx,ny)){ flashHUD('鍵が必要だ…'); return; }
  p.x=nx; p.y=ny; updatePlayerPos(); updateTerrainHUD(); updateCamera(); lockMoveFor(MOVE_DELAY[terrainAt(p.x,p.y)]||100);
  if(Math.random()<encRateAt(p.x,p.y)) startBattle(randomEnemy());
}

/* ========= 会話 ========= */
let typerTimer=null;
function openDialog(lines,choices=[],onChoice=null){ game.dialog.active=true; game.dialog.lines=lines; game.dialog.index=0; document.getElementById('dialog').classList.add('active'); setChoices(choices,onChoice); typeLine(lines[0]); }
function closeDialog(){ document.getElementById('dialog').classList.remove('active'); clearTimeout(typerTimer);
  game.dialog={active:false,lines:[],index:0,choices:[],onChoice:null,typing:false}; choicesEl.innerHTML=''; choicesEl.classList.remove('active'); }
function nextDialog(){ const d=game.dialog; if(d.typing){ skipType(); return; } d.index++; if(d.index>=d.lines.length){ if(d.choices.length){ showChoices(); } else { closeDialog(); } return; } typeLine(d.lines[d.index]); }
function typeLine(text){ clearTimeout(typerTimer); dialogText.textContent=''; game.dialog.typing=true; let i=0; (function tick(){ dialogText.textContent=text.slice(0,i++); if(i<=text.length){ typerTimer=setTimeout(tick,18);}else{ game.dialog.typing=false; } })(); }
function skipType(){ clearTimeout(typerTimer); game.dialog.typing=false; dialogText.textContent=game.dialog.lines[game.dialog.index]; }
function setChoices(choices,onChoice){ game.dialog.choices=choices||[]; game.dialog.onChoice=onChoice||null;
  if(!choices||!choices.length){ choicesEl.innerHTML=''; choicesEl.classList.remove('active'); return; }
  choicesEl.innerHTML=choices.map((c,i)=>`<button class="choice" data-i="${i}" ${i===0?'autofocus':''}>${c.label}</button>`).join('');
  choicesEl.querySelectorAll('.choice').forEach(btn=>btn.addEventListener('click',()=>choose(parseInt(btn.dataset.i,10))));
}
function showChoices(){ choicesEl.classList.add('active'); focusChoice(0); }
function choose(idx){ const d=game.dialog; const opt=d.choices[idx]; if(!opt) return; if(typeof d.onChoice==='function'){ d.onChoice(opt.value??opt.label); } }
function moveChoiceFocus(delta){ const btns=[...choicesEl.querySelectorAll('.choice')]; if(!btns.length) return; let idx=btns.findIndex(b=>b===document.activeElement); if(idx<0) idx=0; let next=(idx+delta+btns.length)%btns.length; focusChoice(next); }
function focusChoice(i){ const btns=[...choicesEl.querySelectorAll('.choice')]; if(!btns.length) return; btns[i].focus(); }

/* ========= Action（看板/宝箱/ゲート） ========= */
function onAction(){
  if(game.mode==='battle'||game.bagOpen||game.saveOpen||game.journalOpen) return;
  if(game.dialog.active){ if(game.dialog.choices.length){ const btns=[...choicesEl.querySelectorAll('.choice')]; const idx=btns.findIndex(b=>b===document.activeElement); choose(idx>-1?idx:0); return; } nextDialog(); return; }
  const px=game.player.x, py=game.player.y;
  const near=(type)=>game.props.find(pr=>pr.type===type && Math.abs(px-pr.x)+Math.abs(py-pr.y)===1);
  const gate=near('gate'), chest=near('chest'), sign=near('sign');
  if(gate){
    if(game.player.items.key>0){
      openDialog(['鍵穴がある… 解錠しますか？'],[{label:'はい（鍵を使う）',value:'useKey'},{label:'いいえ',value:'cancel'}], v=>{
        if(v==='useKey'){ game.player.items.key--; updateInvHUD(); gate.open=true; updatePropSprite(gate,'🟩');
          game.terrain[gate.y][gate.x]=TERRAIN.ROAD; setTimeout(()=>{ gate.el?.remove(); },180);
          game.flags.gateOpen=true; setTaskDone('openGate',true); openDialog(['カチリ… ゲートが 開いた！']); record('解錠','ゲートを開けた'); }
        else openDialog(['やめておこう。']);
      });
    }else openDialog(['鍵が かかっている… 鍵が必要だ。']);
    return;
  }
  if(chest){
    openDialog(['宝箱がある。 開けますか？'],[{label:'はい（開ける）',value:'open'},{label:'いいえ',value:'no'}], v=>{
      if(v==='open'){ chest.opened=true; updatePropSprite(chest,'🧰'); game.player.items.key++; updateInvHUD(); game.flags.chestOpened=true; setTaskDone('openChest',true); openDialog(['鍵を 1 つ 手に入れた！']); record('入手','鍵を手に入れた'); }
      else openDialog(['宝箱を 閉じた。']);
    }); return;
  }
  if(sign){
    openDialog(['ここは広い街道。森は遭遇9%、道は1%。','この先のゲートは鍵で開く。北西に宝箱があるらしい。','回復薬は必要かい？'],
      [{label:'はい（もらう）',value:'getPotion'},{label:'いいえ',value:'skip'}], v=>{
        if(v==='getPotion'){ game.player.items.potion++; updateInvHUD(); openDialog(['回復薬を 1 つ 手に入れた！']); record('入手','回復薬をもらった'); }
        else{ openDialog(['では 良い旅を！']); }
        game.flags.signGiven=true; record('会話','看板の助言を聞いた');
      }); return;
  }
  flashHUD('Action!');
}

/* ========= 戦闘：撃破即判定＋スプライト表示 ========= */
document.getElementById('actAttack').addEventListener('click',()=>turn('attack'));
document.getElementById('actItem').addEventListener('click',()=>turn('item'));
document.getElementById('actRun').addEventListener('click',()=>turn('run'));
document.getElementById('actEnd').addEventListener('click',()=>endBattle());
document.getElementById('actSkill').addEventListener('click',()=>turn('venom'));

function randomEnemy(){
  const presets=[
    {type:'slime',  name:'スライム', emoji:'🫧', hp:28, atk:7, def:1,  affinity:{poison:'weak'}, items:{potion:1}},
    {type:'bat',    name:'こうもり', emoji:'🦇', hp:24, atk:6, def:2,  affinity:{poison:'immune'}, items:{potion:1}},
    {type:'goblin', name:'ゴブリン', emoji:'👹', hp:36, atk:9, def:3,  affinity:{poison:'resist'}, items:{potion:1}},
    {type:'tamakoroshi', name:'たま子ろし',       img:IMG_ASSETS.tamakoroshi, hp:34, atk:8, def:2, affinity:{poison:'normal'}, items:{potion:1}},
    {type:'kuginame',    name:'くぎなめさしくじ', img:IMG_ASSETS.kuginame,    hp:30, atk:7, def:3, affinity:{poison:'resist'}, items:{potion:1}},
    {type:'hitomete',    name:'人目手',           img:IMG_ASSETS.hitomete,    hp:32, atk:8, def:2, affinity:{poison:'immune'}, items:{potion:1}},
    {type:'hitokazuta',  name:'人カヅタ',         img:IMG_ASSETS.hitokazuta,  hp:38, atk:9, def:3, affinity:{poison:'normal'}, items:{potion:1}},
    {type:'toshiyori',   name:'年寄りお化け',     img:IMG_ASSETS.toshiyori,   hp:28, atk:6, def:2, affinity:{poison:'weak'}, items:{potion:1}},
  ];
  const pick=presets[Math.floor(Math.random()*presets.length)];
  return {...pick, hpMax:pick.hp, status:{ poison:{turns:0,dmg:2}, defUp:{turns:0,amount:3} }};
}
function setEnemySprite(enemy){
  enemyStage.innerHTML='';
  if(enemy.img){
    const img = new Image();
    img.className='enemySprite';
    img.alt=enemy.name;
    img.onload = ()=>{ enemyStage.innerHTML=''; enemyStage.appendChild(img); };
    img.onerror = ()=>{
      console.warn('Enemy image failed to load:', enemy.img);
      enemy.img = null; setEnemySprite(enemy);
    };
    img.src = enemy.img + '?v=' + Date.now(); // キャッシュ破り
  }else if(enemy.emoji){
    const span=document.createElement('span');
    span.textContent=enemy.emoji; span.className='emoji';
    enemyStage.appendChild(span);
  }else{
    const span=document.createElement('span');
    span.textContent='👾'; span.className='emoji';
    enemyStage.appendChild(span);
  }
}
function startBattle(enemy){
  game.mode='battle'; game.enemy=enemy;
  fieldEl.style.display='none'; battleEl.classList.add('active');
  setEnemySprite(enemy);
  setLog(`${enemy.name} が あらわれた！`); refreshBars(); stateLabel.textContent='battle';
  record('遭遇', `${enemy.name} と出会った`);
}
function setLog(t){ logEl.textContent=t; }
function dmgCalc(atk,def){ const base=Math.max(1, atk - Math.floor(def*0.6)); return base + Math.floor(Math.random()*3); }
function effAtkP(){ const w=game.player.status.weaken; return Math.max(1, game.player.atk - (w?.turns>0 ? (w.atkDown||3):0)); }
function effDefE(){ const d=game.enemy?.status?.defUp; return (game.enemy?.def||0) + (d?.turns>0 ? (d.amount||3):0); }

function tagsForEnemy(e = game.enemy){
  if(!e) return '';
  const t=[]; const ps=e.status?.poison; const du=e.status?.defUp;
  if(ps?.turns>0) t.push(`☠️x${ps.turns}`); if(du?.turns>0) t.push(`🛡️x${du.turns}`);
  return t.join(' ');
}
function tagsForPlayer(){ const t=[]; const w=game.player.status.weaken; if(w?.turns>0) t.push(`🔻x${w.turns}`); return t.join(' '); }
function refreshBars(){
  const p=game.player, e=game.enemy || {hp:1,hpMax:1,status:{}};
  pHpBar.style.setProperty('--v', Math.max(0, p.hp/p.hpMax));
  eHpBar.style.setProperty('--v', Math.max(0, e.hp/e.hpMax));
  pHpNum.textContent=`${p.hp}/${p.hpMax} ${tagsForPlayer()}`;
  eHpNum.textContent=`${e.hp}/${e.hpMax} ${tagsForEnemy(e)}`;
  updateInvHUD(); checkEnemyDefeated();
}
function checkEnemyDefeated(){ if(game.mode==='battle' && game.enemy && game.enemy.hp<=0){ win(); } }
function turn(action){
  const p=game.player, e=game.enemy;
  if(action==='attack'){
    const d=dmgCalc(effAtkP(), effDefE()); e.hp=Math.max(0,e.hp-d);
    setLog(`あなたの こうげき！ ${e.name} に ${d} ダメージ！`); shake('enemyBattle');
    refreshBars(); if(e.hp<=0) return; enemyPhase();
  }else if(action==='venom'){
    const first=10; e.hp=Math.max(0,e.hp-first);
    let applied=false, note=''; const aff=e.affinity?.poison||'normal';
    if(aff==='immune'){ note='しかし 毒は効かない！'; }
    else if(aff==='resist'){ if(Math.random()<0.5){ e.status.poison={turns:2,dmg:1}; applied=true; } else note='効きにくい…'; }
    else if(aff==='weak'){ e.status.poison={turns:4,dmg:3}; applied=true; }
    else { e.status.poison={turns:3,dmg:2}; applied=true; }
    setLog(`スキル：ベノム！ 初撃${first}ダメージ${applied?'＆毒を付与！':''}${note?`（${note}）`:''}`);
    shake('enemyBattle'); refreshBars(); if(e.hp<=0) return; enemyPhase();
  }else if(action==='item'){
    if(p.items.potion>0 && p.hp>0){
      p.items.potion--; p.hp=Math.min(p.hpMax,p.hp+25);
      setLog(`回復薬を使った！ HPが25回復（残:${p.items.potion}）`); refreshBars(); enemyPhase();
    } else setLog('アイテムがない…');
  }else if(action==='run'){
    if(Math.random()<0.6){ setLog('うまく にげきれた！'); endBattle(); }
    else{ setLog('にげられない！'); enemyPhase(); }
  }
}
function enemyPhase(){
  const p=game.player, e=game.enemy;
  if(e.status?.poison?.turns>0){
    e.hp=Math.max(0, e.hp - e.status.poison.dmg);
    e.status.poison.turns--; setLog(`${e.name} は毒で ${e.status.poison.dmg} ダメージ！`);
    refreshBars(); if(e.hp<=0) return;
  }
  const low=e.hp/e.hpMax<0.30, canHeal=e.items?.potion>0;
  if(low && canHeal && Math.random()<0.5){
    e.items.potion--; const heal=Math.floor(e.hpMax*0.30); e.hp=Math.min(e.hpMax,e.hp+heal);
    setLog(`${e.name} は回復薬を使った！ ${heal} 回復（残:${e.items.potion||0}）`); refreshBars();
  } else {
    if(e.type==='slime' && Math.random()<0.20 && !(e.status.defUp?.turns>0)){
      e.status.defUp={turns:2,amount:3}; setLog('スライムは からだを 固くした！（🛡️2T）'); refreshBars();
    }else if(e.type==='bat' && Math.random()<0.30 && !(p.status.weaken?.turns>0)){
      p.status.weaken.turns=3; setLog('こうもりの スクリーチ！ あなたの 攻撃が 下がった（🔻3T）'); refreshBars();
    }else if(e.type==='goblin' && Math.random()<0.25){
      const d=dmgCalc(e.atk+2, p.def); p.hp=Math.max(0,p.hp-d);
      setLog(`ゴブリンの 強撃！ あなたは ${d} ダメージ！`); shake('playerBattle'); refreshBars(); if(p.hp<=0){ lose(); return; }
    }else{
      const d=dmgCalc(e.atk, p.def); p.hp=Math.max(0,p.hp-d);
      setLog(`${e.name} の こうげき！ あなたは ${d} ダメージ！`); shake('playerBattle'); refreshBars(); if(p.hp<=0){ lose(); return; }
    }
  }
  if(e.status?.defUp?.turns>0) e.status.defUp.turns--;
  if(p.status?.weaken?.turns>0) p.status.weaken.turns--;
}
function win(){ setLog('かちました！'); document.getElementById('actEnd').style.display='inline-block'; toggleActions(true); record('勝利', `${game.enemy.name} を倒した`); }
function lose(){ setLog('たおれてしまった… 回復してフィールドへ戻ります'); game.player.hp=Math.floor(game.player.hpMax*0.6); document.getElementById('actEnd').style.display='inline-block'; toggleActions(true); record('敗北','力尽きた'); }
function endBattle(){ game.mode='field'; stateLabel.textContent='field'; document.getElementById('actEnd').style.display='none';
  toggleActions(false); battleEl.classList.remove('active'); fieldEl.style.display=''; game.enemy=null; setLog(''); refreshBars(); }
function toggleActions(disabled){ ['actAttack','actItem','actRun','actSkill'].forEach(id=>document.getElementById(id).disabled=disabled); }
function shake(id){ const el=document.getElementById(id);
  el.animate([{transform:el.style.transform||'none'},{transform:'translateX(-4px)'},{transform:'translateX(4px)'},{transform:'translateX(0)'}],{duration:160,iterations:1}); }

/* ========= バッグ ========= */
const ITEM_DEFS={
  potion:{ emoji:'🧪', name:'回復薬', desc:'HPを25回復する。戦闘外で使用可。',
    canUse:(ctx)=> ctx.game.mode==='field',
    use:({game})=>{
      if(game.player.items.potion<=0) return toast('回復薬がない…');
      game.player.items.potion--; game.player.hp=Math.min(game.player.hpMax, game.player.hp+25);
      refreshBars(); updateInvHUD(); toast('HPが25回復！'); record('回復','回復薬を使用した');
    }},
  key:{ emoji:'🗝️', name:'鍵', desc:'ゲートの解錠に使える。Actionで使用。', canUse:()=>false, use:()=>{} }
};
document.getElementById('btnBag').addEventListener('click',toggleBag);
document.getElementById('btnCloseBag').addEventListener('click',closeBag);
function toggleBag(){ if(game.mode==='battle'||game.saveOpen||game.journalOpen) return; if(game.bagOpen) closeBag(); else openBag(); }
function openBag(){ game.bagOpen=true; bagSheet.classList.add('active'); bagSheet.setAttribute('aria-hidden','false'); renderBag(); }
function closeBag(){ bagSheet.classList.remove('active'); bagSheet.setAttribute('aria-hidden','true'); game.bagOpen=false; }
function renderBag(){
  const items=[{key:'potion',qty:game.player.items.potion},{key:'key',qty:game.player.items.key}];
  bagList.innerHTML=items.map(({key,qty})=>{ const def=ITEM_DEFS[key]; const can=def.canUse({game,toast});
    return `<div class="itemCard">
      <div class="itemHead"><div class="itemName">${def.emoji} ${def.name}</div><div class="qty">x${qty}</div></div>
      <div class="desc">${def.desc}</div>
      <div><button data-use="${key}" ${(!can||qty<=0)?'disabled':''}>使う</button></div>
    </div>`; }).join('');
  bagList.querySelectorAll('[data-use]').forEach(btn=>btn.addEventListener('click',()=>{ ITEM_DEFS[btn.getAttribute('data-use')].use({game,toast}); renderBag(); }));
}

/* ========= セーブ（3スロット） ========= */
document.getElementById('btnSave').addEventListener('click',()=>openSaveSheet('save'));
document.getElementById('btnLoad').addEventListener('click',()=>openSaveSheet('load'));
document.getElementById('btnCloseSave').addEventListener('click',closeSaveSheet);
tabSave.addEventListener('click',()=>switchSaveMode('save')); tabLoad.addEventListener('click',()=>switchSaveMode('load'));
function openSaveSheet(mode='save'){ if(game.mode==='battle'||game.bagOpen||game.journalOpen) return; game.saveOpen=true; game.saveMode=mode; saveSheet.classList.add('active'); saveSheet.setAttribute('aria-hidden','false'); switchSaveMode(mode); }
function closeSaveSheet(){ saveSheet.classList.remove('active'); saveSheet.setAttribute('aria-hidden','true'); game.saveOpen=false; }
function switchSaveMode(mode){ game.saveMode=mode; tabSave.classList.toggle('active',mode==='save'); tabLoad.classList.toggle('active',mode==='load'); renderSlots(); }
function getSlot(n){ try{ const raw=localStorage.getItem(SAVE_PREFIX+n); return raw?JSON.parse(raw):null; }catch(e){ return null; } }
function putSlot(n,data){ localStorage.setItem(SAVE_PREFIX+n, JSON.stringify(data)); }
function delSlot(n){ localStorage.removeItem(SAVE_PREFIX+n); }
function snap(){ return {version:'v2.0', savedAt:Date.now(), player:JSON.parse(JSON.stringify(game.player)), flags:JSON.parse(JSON.stringify(game.flags)), journal:JSON.parse(JSON.stringify(game.journal))}; }
function applySnap(s){ Object.assign(game.player,s.player||{}); Object.assign(game.flags,s.flags||{}); if(s.journal){ game.journal=JSON.parse(JSON.stringify(s.journal)); }
  updatePlayerPos(); updateTerrainHUD(); updateCamera(); refreshBars(); buildWorld(); }
function slotSummary(s){ if(!s) return {title:'（空き）',meta:'未保存',body:'—'}; const p=s.player||{}, f=s.flags||{};
  const items=p.items?`P:${p.items.potion??0} / K:${p.items.key??0}`:''; const flags=`Gate:${f.gateOpen?'Open':'Close'} / Chest:${f.chestOpened?'Open':'Close'}`;
  return { title:`HP ${p.hp??'-'}/${p.hpMax??'-'}　座標 ${p.x??'-'},${p.y??'-'}`, meta:`${s.version}・${fmtTime(s.savedAt)}`, body:`所持 ${items}　|　${flags}` };
}
function renderSlots(){
  slotList.innerHTML=[1,2,3].map(i=>{
    const s=getSlot(i), sum=slotSummary(s), mode=game.saveMode;
    const actions=mode==='save'
      ? `<button data-act="save" data-i="${i}">${s?'上書き保存':'保存'}</button>`
      : `<button data-act="load" data-i="${i}" ${s?'':'disabled'}>ロード</button><button data-act="delete" data-i="${i}" ${s?'':'disabled'}>削除</button>`;
    return `<div class="slotCard">
      <div class="slotHead"><div>スロット ${i}</div><div class="meta">${sum.meta}</div></div>
      <div class="slotBody">${sum.title}<br>${sum.body}</div>
      <div style="display:flex; gap:8px; justify-content:flex-end">${actions}</div>
    </div>`;
  }).join('');
  slotList.querySelectorAll('[data-act]').forEach(btn=>{
    const act=btn.getAttribute('data-act'); const i=parseInt(btn.getAttribute('data-i'),10);
    btn.addEventListener('click',()=>{
      if(act==='save'){ const exist=getSlot(i); if(exist && !confirm('このスロットに上書きします。よろしいですか？')) return; putSlot(i,snap()); toast2(`スロット ${i} に保存しました`); renderSlots(); }
      else if(act==='load'){ const s=getSlot(i); if(!s){ toast2('空のスロットです'); return; } applySnap(s); toast2(`スロット ${i} をロードしました`); closeSaveSheet(); }
      else if(act==='delete'){ if(confirm('このスロットを削除しますか？')){ delSlot(i); toast2(`スロット ${i} を削除しました`); renderSlots(); } }
    });
  });
}

/* ========= ジャーナル ========= */
document.getElementById('btnJournal').addEventListener('click', ()=> openJournal('log'));
document.getElementById('btnCloseJournal').addEventListener('click', closeJournal);
document.getElementById('btnClearLog').addEventListener('click', ()=>{ if(confirm('出来事ログを消去しますか？')){ game.journal.entries=[]; renderJournal(); toast3('ログを消去しました'); }});
tabJLog.addEventListener('click', ()=> switchJournalMode('log'));
tabJTask.addEventListener('click', ()=> switchJournalMode('task'));
function openJournal(mode='log'){ if(game.mode==='battle'||game.bagOpen||game.saveOpen) return; game.journalOpen=true; game.journalMode=mode; journalSheet.classList.add('active'); journalSheet.setAttribute('aria-hidden','false'); switchJournalMode(mode); }
function closeJournal(){ journalSheet.classList.remove('active'); journalSheet.setAttribute('aria-hidden','true'); game.journalOpen=false; }
function switchJournalMode(mode){ game.journalMode=mode; document.getElementById('tabJLog').classList.toggle('active', mode==='log'); document.getElementById('tabJTask').classList.toggle('active', mode==='task'); renderJournal(); }
function renderJournal(){
  if(game.journalMode==='log'){
    journalList.innerHTML = game.journal.entries.length
      ? game.journal.entries.map(e=>`
        <div class="logCard">
          <div class="logHead"><div class="chip">${e.tag}</div><div class="meta">${fmtTime(e.t)} ｜ 座標 ${e.x},${e.y}</div></div>
          <div class="logBody">${e.text}</div>
        </div>`).join('')
      : `<div class="muted" style="padding:6px 10px;">まだ出来事はありません。</div>`;
  }else{
    journalList.innerHTML = game.journal.tasks.map(t=>`
      <div class="taskCard ${t.done?'done':''}">
        <div class="taskHead"><div>${t.done?'✅':'🧭'} ${t.title}</div><div class="meta">${t.done?'<span class="done">完了</span>':'進行中'}</div></div>
        <div class="taskBody">${t.done?'よくできました！':'ヒント：北西に宝箱／中央東にゲート'}</div>
        <div style="display:flex; gap:8px; justify-content:flex-end"><button data-tid="${t.id}" data-act="${t.done?'undone':'done'}">${t.done?'未完に戻す':'完了にする'}</button></div>
      </div>`).join('');
    journalList.querySelectorAll('[data-tid]').forEach(btn=>{
      btn.addEventListener('click', ()=>{ const id=btn.getAttribute('data-tid'); const act=btn.getAttribute('data-act'); setTaskDone(id, act==='done'); renderJournal(); });
    });
  }
}

/* ========= 初期化 ========= */
function syncTasksWithFlags(){ setTaskDone('openChest', !!game.flags.chestOpened); setTaskDone('openGate',  !!game.flags.gateOpen); }
document.getElementById('btnHeal').addEventListener('click', ()=>{ game.player.hp=Math.min(game.player.hpMax, game.player.hp+20); refreshBars(); flashHUD('回復 +20'); });
document.getElementById('btnReset').addEventListener('click', ()=>{
  localStorage.removeItem('miniRPG');
  game.player={ x:Math.floor(MAP_W/2), y:Math.floor(MAP_H/2), hp:60,hpMax:60,atk:12,def:3, items:{potion:2, key:0}, status:{weaken:{turns:0, atkDown:3}} };
  game.flags={ signGiven:false, tutorialDone:false, gateOpen:false, chestOpened:false };
  game.journal.entries=[]; game.journal.tasks.forEach(t=>t.done=false);
  updatePlayerPos(); updateTerrainHUD(); updateCamera(); refreshBars(); buildWorld(); syncTasksWithFlags(); flashHUD('現在の状態を初期化'); record('初期化','状態をリセットした');
});
function boot(){ genTerrain(); buildWorld(); syncTasksWithFlags(); record('開始','冒険を始めた'); }
boot();
</script>
</body>
</html>
