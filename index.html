<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>NEO FIELD QUEST</title>
<style>
body{margin:0;background:#0b0f14;color:#e5f1ff;font-family:sans-serif;display:flex;flex-direction:column;align-items:center;overflow:hidden}
canvas{border:2px solid #20ffe3;border-radius:12px;margin:8px;image-rendering:pixelated}
.hud{display:flex;gap:12px;margin:8px}
.panel{background:#0e1520aa;padding:8px 12px;border-radius:8px;border:1px solid #223545}
.hpbar{height:8px;background:#092231;border-radius:6px;overflow:hidden}
.hpfill{height:100%;background:linear-gradient(90deg,#20ffe3,#5df6ff)}
.controller{position:fixed;bottom:20px;width:100%;display:flex;justify-content:space-between;padding:0 40px;pointer-events:none}
.dpad,.buttons{pointer-events:auto}
.dpad{display:grid;grid-template-columns:repeat(3,100px);grid-template-rows:repeat(3,100px);gap:8px}
.dpad button{width:100px;height:100px;font-size:28px;border-radius:20px}
.buttons{display:flex;flex-direction:column;gap:20px}
.buttons button{width:120px;height:100px;font-size:22px;border-radius:20px}
.btn{background:#0a121d;border:1px solid #1e3550;color:#e5f1ff;font-weight:bold}
.btn:active{transform:translateY(1px)}
.A{border-color:#20ffe3;color:#20ffe3}
.B{border-color:#ff4dcb;color:#ff4dcb}
.overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#000c;z-index:5}
.card{background:#08111b;border:2px solid #20ffe3;border-radius:12px;padding:20px;min-width:280px;text-align:center}
.hidden{display:none}
#npcOverlay .card{ text-align:left; font-size:18px; line-height:1.6em; max-width:420px }
#shopItems button{display:block;width:100%;margin:5px 0;padding:10px;font-size:18px}
</style>
</head>
<body>
<div class="hud">
  <div class="panel">
    <div>Lv:<span id="plv">1</span> HP:<span id="php">30</span>/<span id="pmax">30</span></div>
    <div class="hpbar"><div id="phpfill" class="hpfill"></div></div>
    <div>æ‰€æŒé‡‘:<span id="pgold">0</span>å††</div>
  </div>
</div>

<canvas id="view" width="256" height="256"></canvas>
<canvas id="minimap" width="128" height="128" style="position:fixed;top:10px;right:10px;border:1px solid #20ffe3"></canvas>

<div class="controller">
  <div class="dpad">
    <div></div><button class="btn" data-dir="up">â–²</button><div></div>
    <button class="btn" data-dir="left">â—€</button><div></div><button class="btn" data-dir="right">â–¶</button>
    <div></div><button class="btn" data-dir="down">â–¼</button><div></div>
  </div>
  <div class="buttons">
    <button class="btn A" id="btnA">æ±ºå®š</button>
    <button class="btn B" id="btnB">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
  </div>
</div>

<!-- NPCå¹ãå‡ºã— -->
<div id="npcOverlay" class="overlay hidden">
  <div class="card">
    <h2 id="npcName">æ‘äºº</h2>
    <p id="npcLine"></p>
    <button class="btn A" id="npcClose">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- ã‚·ãƒ§ãƒƒãƒ—UI -->
<div id="shopOverlay" class="overlay hidden">
  <div class="card">
    <h2 id="shopTitle">ã‚·ãƒ§ãƒƒãƒ—</h2>
    <div id="shopItems"></div>
    <p id="shopMsg"></p>
    <button class="btn B" id="shopClose">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- æˆ¦é—˜UI -->
<div id="battleOverlay" class="overlay hidden">
  <div class="card">
    <h2 id="enemyName"></h2>
    <div>HP: <span id="ehp"></span></div>
    <button class="btn A" id="atkBtn">æ”»æ’ƒ</button>
    <button class="btn B" id="runBtn">é€ƒã’ã‚‹</button>
  </div>
</div>

<!-- ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚° -->
<div id="endingOverlay" class="overlay hidden">
  <div class="card">
    <h2>ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°</h2>
    <p id="endingText">å¹³å’ŒãŒãŠã¨ãšã‚ŒãŸâ€¦</p>
    <button class="btn A" onclick="location.reload()">æœ€åˆã‹ã‚‰</button>
  </div>
</div>

<script>
(()=> {
const $=id=>document.getElementById(id);

// ====== Audio ======
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();
let bgmInterval=null;
function playBeep(freq=440,duration=0.2,type="square",vol=0.2){
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  osc.type=type; osc.frequency.setValueAtTime(freq,audioCtx.currentTime);
  gain.gain.setValueAtTime(vol,audioCtx.currentTime);
  osc.connect(gain).connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime+duration);
}
function sfxMove(){ playBeep(200,0.05,"square",0.1); }
function sfxAttack(){ playBeep(600,0.1,"sawtooth",0.2); }
function sfxDamage(){ playBeep(120,0.2,"triangle",0.2); }
function sfxFanfare(){ playBeep(600,0.15,"square");setTimeout(()=>playBeep(800,0.15,"square"),200);setTimeout(()=>playBeep(1000,0.3,"square"),400); }
function stopBGM(){ clearInterval(bgmInterval); bgmInterval=null; }
function startFieldBGM(){ if(bgmInterval) return; const notes=[262,330,392,523]; let i=0; bgmInterval=setInterval(()=>{playBeep(notes[i%notes.length],0.25,"sine",0.05); i++;},500);}
function startBattleBGM(){ if(bgmInterval) return; const notes=[220,262,294,330]; let i=0; bgmInterval=setInterval(()=>{playBeep(notes[i%notes.length],0.15,"square",0.08); i++;},250); }

// ====== ãƒãƒƒãƒ— ======
const TILE=16,W=64,H=64;
const T={GRASS:0,TOWN:1,CASTLE:2,CAVE:3,VILLAGE:4,TEMPLE:5,FOREST:6,RIVER:7};
let map=[...Array(H)].map(()=>Array(W).fill(T.GRASS));
for(let y=0;y<H;y++)for(let x=0;x<W;x++){ if(Math.random()<0.1)map[y][x]=T.FOREST; if(Math.random()<0.05)map[y][x]=T.RIVER;}
map[5][5]=T.CASTLE; map[30][32]=T.CAVE; map[10][20]=T.TOWN; map[40][50]=T.VILLAGE; map[25][45]=T.TEMPLE;

// ====== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ======
const player={x:2,y:2,hp:30,max:30,exp:0,gold:0,lv:1};
let templeUsed=false;

// ====== ã‚·ãƒ§ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ ======
const shopData={
  town:{title:"ç”ºã®ã‚·ãƒ§ãƒƒãƒ—",items:[{name:"ã‚¹ã‚¤ãƒƒãƒï¼’",price:40000},{name:"ãƒã‚±ã‚«ãƒ‘ãƒƒã‚¯",price:200},{name:"çˆ¶ã®æ²¹çµµ",price:300000}],noMoney:"æã‚Œå…¥ã‚Šã¾ã™ãŒã€ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ã‚",thanks:"ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã¾ãŸãŠè¶Šã—ãã ã•ã„ã¾ã›"},
  village:{title:"æ‘ã®åº—",items:[{name:"ããªã“ã®é¤Œ",price:400},{name:"ãƒ¡ãƒ­ãƒ³ã®ã‚¿ãƒ",price:10},{name:"ä»™äººãƒãƒ³ã®æ¼«ç”»ã‚»ãƒƒãƒˆ",price:10000},{name:"é‰„é‰±çŸ³",price:1000}],noMoney:"ãŠé‡‘ãŒè¶³ã‚Šãªã„ã˜ã‚ƒãªã„ã‹ï¼ãŠã¨ã¨ã„ãã‚„ãŒã‚Œ",thanks:"ã¸ã¸ã¸ã€æ¯åº¦ã‚ã‚Š"}
};

// ã‚·ãƒ§ãƒƒãƒ—è¡¨ç¤º
function openShop(type){
  const data=shopData[type];
  $("shopTitle").textContent=data.title;
  $("shopItems").innerHTML="";
  data.items.forEach(item=>{
    const btn=document.createElement("button");
    btn.textContent=`${item.name} ${item.price}å††`;
    btn.onclick=()=>{
      if(player.gold<item.price){
        $("shopMsg").textContent=data.noMoney;
      }else{
        player.gold-=item.price;
        $("pgold").textContent=player.gold;
        $("shopMsg").textContent=data.thanks;
      }
    };
    $("shopItems").appendChild(btn);
  });
  $("shopMsg").textContent="";
  $("shopOverlay").classList.remove("hidden");
}
$("shopClose").onclick=()=>{ $("shopOverlay").classList.add("hidden"); };

// ====== ç¥æ®¿ ======
function enterTemple(){
  if(templeUsed){ alert("å·«å¥³: ã‚ãªãŸã«ã¯ã‚‚ã†åŠ›ã‚’æˆã‘ã‚‰ã‚Œã¾ã›ã‚“"); return; }
  player.lv++; player.max+=5; player.hp=player.max; templeUsed=true;
  $("plv").textContent=player.lv; $("pmax").textContent=player.max; $("php").textContent=player.hp; $("phpfill").style.width="100%";
  alert("å·«å¥³: ã‚ãªãŸã®åŠ›ã‚’å°‘ã—ã ã‘é«˜ã‚ã¾ã—ãŸã€‚");
}

// ====== NPC ======
const npcs=[{x:6,y:6,type:"town"},{x:56,y:21,type:"village"},{x:40,y:10,type:"field"}];
const npcDialog={
  town:["ã‚ˆã†ã“ãã€å‹‡è€…æ§˜ã€‚ã“ã®ç”ºã¯å¹³å’Œãã®ã‚‚ã®ã§ã™ã€‚","åŒ—ã«åŸãŒã‚ã‚Šã¾ã™ã€‚ç‹æ§˜ãŒãŠå¾…ã¡ã§ã™ã‚ˆã€‚"],
  village:["ãŠã†ã€å‹‡è€…ï¼å…ƒæ°—ãã†ã ãªã€‚","æ´çªŸã«ã¯è¿‘ã¥ããªã‚ˆã€‚é­”ç‹ãŒã„ã‚‹ã‚“ã ã‹ã‚‰ãªï¼"],
  field:["æ—…ã¯æ¥½ã—ã„ã‹ï¼Ÿç§ã¯æ™¯è‰²ã‚’çœºã‚ã¦ã„ã‚‹ã ã‘ã§å¹¸ã›ã•ã€‚","æ£®ã«ã¯çã—ã„é­”ç‰©ãŒå‡ºã‚‹ãã€æ°—ã‚’ã¤ã‘ãªï¼"]
};
function talkToNPC(type){
  let line="â€¦",name="æ‘äºº";
  if(type==="town"){ line=npcDialog.town[Math.floor(Math.random()*npcDialog.town.length)]; name="ç”ºã®æ‘äºº"; }
  else if(type==="village"){ line=npcDialog.village[Math.floor(Math.random()*npcDialog.village.length)]; name="æ‘ã®æ‘äºº"; }
  else{ line=npcDialog.field[Math.floor(Math.random()*npcDialog.field.length)]; name="æ—…ã®äºº"; }
  $("npcName").textContent=name; $("npcLine").textContent=line;
  $("npcOverlay").classList.remove("hidden");
}
$("npcClose").onclick=()=>{ $("npcOverlay").classList.add("hidden"); };

// ====== æˆ¦é—˜ ======
let enemy=null,bossBattle=false;
const enemies=[{name:"ã‚¹ãƒ©ã‚¤ãƒ ",hp:8,atk:3,exp:5,gold:5},{name:"ä»™äººãƒãƒ³",hp:15,atk:5,exp:8,gold:10},{name:"ã¯ãªãã‚“",hp:20,atk:6,exp:10,gold:15},{name:"ã¯ãã‚Œã­ã“ãã‚“",hp:10,atk:10,exp:50,gold:100,rare:true},{name:"ã‚¯ãƒ«ãƒŸã£ã½",hp:12,atk:12,exp:60,gold:120,rare:true}];
function startBattle(isBoss=false){
  stopBGM(); startBattleBGM();
  bossBattle=isBoss;
  if(isBoss){ enemy={name:"é­”ç‹",hp:50,atk:12,exp:100,gold:300}; }
  else{
    let pool=enemies.slice(0,3); if(Math.random()<0.33) pool=pool.concat(enemies.slice(3));
    enemy=JSON.parse(JSON.stringify(pool[Math.floor(Math.random()*pool.length)]));
  }
  $("enemyName").textContent=enemy.name; $("ehp").textContent=enemy.hp;
  $("battleOverlay").classList.remove("hidden");
}
$("atkBtn").onclick=()=>{
  sfxAttack(); enemy.hp-=5; if(enemy.hp<0)enemy.hp=0;
  $("ehp").textContent=enemy.hp;
  if(enemy.hp<=0){
    $("battleOverlay").classList.add("hidden");
    player.exp+=enemy.exp; player.gold+=enemy.gold;
    $("pgold").textContent=player.gold;
    stopBGM(); startFieldBGM();
    if(bossBattle) showEnding();
    return;
  }
  setTimeout(()=>{
    sfxDamage(); player.hp-=enemy.atk;
    if(player.hp<=0){ alert("å‹‡è€…ã¯å€’ã‚ŒãŸâ€¦"); location.reload(); }
    $("php").textContent=player.hp; $("phpfill").style.width=(player.hp/player.max*100)+"%";
  },500);
};
$("runBtn").onclick=()=>{ if(bossBattle){ alert("é€ƒã’ã‚‰ã‚Œãªã„ï¼"); return; }
  $("battleOverlay").classList.add("hidden"); stopBGM(); startFieldBGM(); };

// ====== ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚° ======
function showEnding(){
  stopBGM(); sfxFanfare();
  $("endingText").textContent="å‹‡è€…ã¯é­”ç‹ã‚’å€’ã—ã€ä¸–ç•Œã«å¹³å’ŒãŒæˆ»ã£ãŸï¼\näººã€…ã¯æ­“å–œã—ã€ç‹ã¯å‹‡è€…ã‚’è®ƒãˆãŸï¼";
  $("endingOverlay").classList.remove("hidden");
}

// ====== æç”» ======
const view=$("view"),ctx=view.getContext("2d");
const mini=$("minimap"),mctx=mini.getContext("2d");
function draw(){
  ctx.fillStyle="#000"; ctx.fillRect(0,0,view.width,view.height);
  const half=8,cx=player.x,cy=player.y;
  for(let dy=-half;dy<=half;dy++)for(let dx=-half;dx<=half;dx++){
    const mx=cx+dx,my=cy+dy; if(mx<0||my<0||mx>=W||my>=H)continue;
    let t=map[my][mx],emoji="";
    if(t===T.TOWN)emoji="ğŸ˜ï¸"; if(t===T.CASTLE)emoji="ğŸ°"; if(t===T.CAVE)emoji="ğŸ•³ï¸"; if(t===T.VILLAGE)emoji="ğŸ›–"; if(t===T.TEMPLE)emoji="ğŸ›ï¸"; if(t===T.FOREST)emoji="ğŸŒ³";
    const px=(dx+half)*TILE,py=(dy+half)*TILE; ctx.fillStyle="#1c1c1c";ctx.fillRect(px,py,TILE,TILE);
    if(emoji) ctx.fillText(emoji,px+2,py+14);
  }
  ctx.fillText("ğŸƒâ€â™‚ï¸â€â¡ï¸",half*TILE+2,half*TILE+14);
  drawMiniMap();
}
function drawMiniMap(){
  const scale=2; mctx.fillStyle="#000";mctx.fillRect(0,0,mini.width,mini.height);
  mctx.fillStyle="#fff"; [T.TOWN,T.CASTLE,T.CAVE,T.VILLAGE,T.TEMPLE].forEach(tt=>{
    for(let y=0;y<H;y++)for(let x=0;x<W;x++){ if(map[y][x]===tt) mctx.fillRect(x*scale,y*scale,scale,scale); }
  });
  mctx.fillStyle="orange"; mctx.fillRect(player.x*scale,player.y*scale,scale,scale);
}

// ====== ç§»å‹• ======
function move(dx,dy){
  const nx=player.x+dx,ny=player.y+dy;
  if(nx<0||ny<0||nx>=W||ny>=H) return; if(map[ny][nx]===T.RIVER) return;
  player.x=nx;player.y=ny; sfxMove();
  $("php").textContent=player.hp; $("phpfill").style.width=(player.hp/player.max*100)+"%"; draw();
  if(Math.random()<0.05 && ![T.TOWN,T.VILLAGE,T.CASTLE,T.TEMPLE].includes(map[ny][nx])) startBattle(false);
  if(map[ny][nx]===T.CAVE) startBattle(true);
  if(map[ny][nx]===T.TOWN) openShop("town");
  if(map[ny][nx]===T.VILLAGE) openShop("village");
  if(map[ny][nx]===T.TEMPLE) enterTemple();
}
document.querySelectorAll(".dpad .btn").forEach(b=>{
  b.onclick=()=>{const d=b.dataset.dir;if(d==="up")move(0,-1);if(d==="down")move(0,1);if(d==="left")move(-1,0);if(d==="right")move(1,0);}
});
$("btnA").onclick=()=>{ /* NPCä¼šè©±(çœç•¥:é…ç½®æ¸ˆã¿NPCãªã‚‰talkToNPCå‘¼ã³å‡ºã—å¯) */ };

draw(); startFieldBGM();

})();
</script>
</body>
</html>
